<!DOCTYPE html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
    <link rel="canonical" href="https://blog.dgraph.io/post/v0.9/" />


    <link rel="apple-touch-icon" sizes="57x57" href="https://dgraph.io/assets/images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://dgraph.io/assets/images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://dgraph.io/assets/images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://dgraph.io/assets/images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://dgraph.io/assets/images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://dgraph.io/assets/images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://dgraph.io/assets/images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://dgraph.io/assets/images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://dgraph.io/assets/images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://dgraph.io/assets/images/favicons/android-icon-192x192.png">
    <link rel="manifest" href="https://dgraph.io/assets/images/favicons/manifest.json">
    <link rel="icon" type="image/png" sizes="32x32" href="https://dgraph.io/assets/images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://dgraph.io/assets/images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://dgraph.io/assets/images/faviconsfavicon-16x16.png">
    <link rel="shortcut icon" href="https://dgraph.io/assets/images/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="https://dgraph.io/assets/images/faviconsms-icon-144x144.png">
    <meta name="msapplication-config" content="https://dgraph.io/assets/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.dgraph.io//index.xml">
  
    <title>Releasing distributed transactions in v0.9 - Dgraph Blog</title>
    <meta property='og:title' content="Releasing distributed transactions in v0.9 - Dgraph Blog">
    <meta property="og:type" content="article">
  

  <meta property="og:url" content="https://blog.dgraph.io/post/v0.9/">
  
  <meta property="og:image" content="https://blog.dgraph.io//images/when_neutron_stars_collide.jpg">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" integrity="sha256-0rguYS0qgS6L4qVzANq4kjxPLtvnp5nn2nB5G1lWRv4=" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/default.min.css" rel="stylesheet" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js" integrity="sha256-sNPiigbfSkqUzMc5rgrdztLnneCMAp6W9wetJUZu9Zw=" crossorigin="anonymous"></script>

  <link
    href='https://blog.dgraph.io//css/runnable.css?7bbf71b4888bc97241e85bc7326a12fe'
    rel="stylesheet"
  />
  <link
    href='https://blog.dgraph.io//css/runnable-custom.css?74110b504a7b8a6e92a95279cfa96032'
    rel="stylesheet"
  />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500&display=swap" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

  <link href="https://dgraph.io/assets/css/style.min.css?05042020-3" rel="stylesheet" type="text/css" />

  <link href="https://dgraph.io/assets/css/font-awesome/css/all.css" rel="stylesheet"/>

  <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.js" integrity="sha256-x3BtPVERvw1ozPlwivuFLZoViFCeAAs1Gt6SxEedmo8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.css" integrity="sha256-7sZe9dsqyNZC9Mk+WPRB7nVvPPPXyorzm2QKqlgXC4k=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/addon/edit/closebrackets.min.js" integrity="sha256-qhu2a7DSpQaammMaLw1iruxBpxmgdw8mdQaQWQUokcY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/javascript/javascript.min.js" integrity="sha256-7Bdg/UdDMmHDPafpQDYZNPCEbnRP7eAvu+2hEoqRCXs=" crossorigin="anonymous"></script>
  

  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@3/dist/algoliasearch.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.0.0/dist/instantsearch.production.min.js" integrity="sha256-6S7q0JJs/Kx4kb/fv0oMjS855QTz5Rc2hh9AkIUjUsk=" crossorigin="anonymous"></script>
  <script src="https://blog.dgraph.io//js/search.js?04292020"></script>

  
  
    
      <meta name="twitter:card" content="summary_large_image"/>
      <meta name="twitter:image" content="https://blog.dgraph.io//images/when_neutron_stars_collide.jpg"/>
    
  

  <meta name="twitter:title" content="Releasing distributed transactions in v0.9"/>
  <meta name="twitter:description" content="It all started with a Github issue.
At Dgraph, we really care about user feedback. Most of what we&rsquo;ve built starting January 2017, has been based what our community (that&rsquo;s you!"/>
  <meta name="twitter:site" content="@dgraphlabs"/>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-666192333"></script>
  <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'AW-666192333');</script>
</head>


<body class="blog-single has-lightning" data-gr-c-s-loaded="true">

    <header id="page-header" class="page-header">
	<div class="page-logo">
		<a href="https://dgraph.io/">
			<img src="https://dgraph.io/assets/images/logo.svg">
		</a>
	</div>
	<nav class="page-nav">
    <ul>
        <li>
            <div data-label="Products">
                <span>Products</span>
            </div>
            <ul>
                <li>
                    <a href="https://dgraph.io/graphql" data-label="GraphQL">
                        <span>GraphQL</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/enterprise" data-label="Enterprise">
                        <span>Enterprise</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/downloads" data-label="Downloads">
                        <span>Downloads</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Learn" class="is-active">
                <span>Learn</span>
            </div>
            <ul>
                <li>
                    <a href="https://dgraph.io/blog" data-label="Blog">
                        <span>Blog</span>
                    </a>
                </li>
                <li>
                    <a href="https://tour.dgraph.io" target="_blank" data-label="Interactive Tour">
                        <span>Interactive Tour</span>
                    </a>
                </li>
                <li>
                    <a href="https://discuss.dgraph.io" target="_blank" data-label="Forum">
                        <span>Forum</span>
                    </a>
                </li>
                <li>
                    <a href="https://slack.dgraph.io" target="_blank" data-label="Slack">
                        <span>Slack</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Docs"><span>Docs</span></div>
            <ul>
                <li>
                    <a href="https://docs.dgraph.io" target="_blank" data-label="Dgraph Docs">
                        <span>Dgraph Docs</span>
                    </a>
                </li>
                <li>
                    <a href="https://graphql.dgraph.io/docs/" target="_blank" data-label="GraphQL Docs">
                        <span>GraphQL Docs</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Company"><span>Company</span></div>
            <ul>
                <li>
                    <a href="https://dgraph.io/about" data-label="Team">
                        <span>Team</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/careers" data-label="Careers">
                        <span>Careers</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/contact" data-label="Contact">
                        <span>Contact</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/conduct" data-label="Conduct">
                        <span>Conduct</span>
                    </a>
                </li>
            </ul>
        </li>
    </ul>
</nav>

	<div class="page-cta">
    <ul>
        <li class="hide-tablet">
            <a href="https://dgraph.io/contact" title="Contact">Contact</a>
        </li>
        <li>
            <a href="https://dgraph.io/downloads" title="Download" class="button button--secondary">
                <span>Download</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </li>
    </ul>
</div>

</header>




    <section class="page-body">
        <div class="container">
            <div class="row">

                <div class="col-12 col-md-8">
                    <div class="page-body__content post">

                        <div class="post__meta">

                            <div class="post__date">

    
        Tue, Nov 14, 2017
    
    
</div>


                            <div class="post__share">
                                
                                    <a href="https://twitter.com/share?text=Releasing%20distributed%20transactions%20in%20v0.9&amp;url=https%3a%2f%2fblog.dgraph.io%2fpost%2fv0.9%2f&amp;via=dgraphlabs" target="_blank">
                                        <i class="fab fa-twitter"></i>
                                    </a>
                                
                            </div>

                        </div>

                        <div class="post__cover">

                            <img src="https://blog.dgraph.io//images/when_neutron_stars_collide.jpg">

                            <div class="post__header">

                                <h1 class="post__title">
                                    Releasing distributed transactions in v0.9
                                </h1>

                                
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/peter/">Peter Stace</a>
        
    

</div>



                            </div>

                        </div>

                        <div class="post__content">
                            <p><strong>It all started with a Github issue.</strong></p>
<p>At Dgraph, we really care about user feedback. Most of what we&rsquo;ve built starting
January 2017, has been based what our community (<em>that&rsquo;s you!</em>) told us.  The
biggest contribution that we get from our community, is in the form of feedback.
We&rsquo;ll forgo any code contribution for quality feedback based on real-world
usage.</p>
<p>Since the beginning of Dgraph, transactions were road mapped as a post v1.0
feature.  Dgraph is a distributed and synchronously replicated system. Adding
transactions in such a system is a hard challenge; something that we felt
wasn&rsquo;t worth the complexity to tackle early on.</p>
<p>That changed when <a href="https://twitter.com/gniemeyer">Gustavo Niemeyer</a> filed <a href="https://github.com/dgraph-io/dgraph/issues/1445">this issue</a>. In
this issue, he made a very convincing case for supporting transactions sooner
rather than later.</p>
<blockquote>
<p>So, coming back to Dgraph, if the idea is indeed to position it as a general
alternative for existing databases as I&rsquo;ve watched in one of your videos,
please don&rsquo;t make the same mistake of postponing transactions for too long,
or voicing them as relevant mainly for financial transactions. The sort of
consistency at stake is relevant for pretty much any application at all that
uses data, even more when even basic details about a record are recorded as
multiple individual terms. This would make the situation even worse than with
MongoDB. &ndash;Gustavo</p>
</blockquote>
<p>The arguments made by Gustavo were intriguing enough for us to look seriously
in that direction. Once we started looking, evidence was everywhere.  People
have been complaining about lack of transactions in MongoDB. Bigtable author
and Google Fellow, Jeff Dean, considered not implementing transactions in Bigtable
his <a href="http://highscalability.com/blog/2016/3/16/jeff-dean-on-large-scale-deep-learning-at-google.html">&ldquo;biggest mistake as an engineer&rdquo;</a>.</p>
<p>It was clear that transactions were something that we should implement right
away.</p>
<p>So that&rsquo;s what we did. We used what we call the <strong>Blitzkrieg approach</strong>.
Explaining it can be a blog post of its own, but the general idea is that a
single or a very small set of engineers work initially to make changes deep into
the core, which would break most things minus the core (possibly one package).
And then the rest of the team helps fix up the outer shells level by level. We
use this technique regularly to implement major design changes at a lightning
speed.</p>
<p>The entire work from the reporting of the <a href="https://github.com/dgraph-io/dgraph/issues/1445">issue</a> (Sep 13) to implementing
<a href="https://blog.dgraph.io/post/badger-txn/">transactions in Badger</a> (Oct 5), to releasing <a href="https://github.com/dgraph-io/dgraph/releases/tag/v0.9.0">v0.9 with
transactions</a> (on Nov 14), was done <strong>within a time span of two
months.</strong></p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Wow.. that&#39;s an amazing turnaround time for that level of complexity. Thank you! <a href="https://t.co/niILz03jw0">https://t.co/niILz03jw0</a></p>&mdash; Gustavo Niemeyer (@gniemeyer) <a href="https://twitter.com/gniemeyer/status/930459384131538944?ref_src=twsrc%5Etfw">November 14, 2017</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p><em>In this blog post, we won&rsquo;t go into the details of how Dgraph&rsquo;s transactions
work. There&rsquo;s a lot of interesting bits there, due to the uniqueness of this
challenge; so the team decided that a blog post won&rsquo;t do justice to what has
gone into building this amazingly distributed graph database over the past two
years. Instead, we plan to write a technical paper about Dgraph&rsquo;s unique design.
Watch for that in the coming months!</em></p>
<p>So, instead of how it works, this blog post focuses on how to use transactions
to build your application.</p>
<h2 id="the-transaction-model">The transaction model</h2>
<p>Transactions come along with a new model for how to interact with Dgraph.
Previously, it has just been single queries and data mutations on their own.
Now all queries and mutations are performed as part of a transaction.</p>
<p><strong>Dgraph can perform read-modify-write transactions,</strong> the typical lifecycle
being:</p>
<ol>
<li>
<p>Create a transaction. Go client: <code>client.NewTxn()</code>.</p>
</li>
<li>
<p>Execute a series of queries and mutations. Go client: <code>txn.Mutate(...)</code> and
<code>txn.Query(...)</code>.</p>
</li>
<li>
<p>Finally, commit or abort the transaction. Go client: <code>txn.Commit()</code> and
<code>txn.Abort()</code>.</p>
</li>
</ol>
<p>If two concurrently running transactions write to the same data, then one of the
commits will fail. It&rsquo;s up to the user to retry.</p>
<h2 id="why-are-transactions-important">Why are transactions important?</h2>
<p>Database transactions are important for any app that needs to update its state
based upon its previous state in a consistent manner or has operations that
need to apply in atomic units.</p>
<p>That covers a lot of different things. Just to name a few:</p>
<ul>
<li>
<p>Marking inventory in an online shop as sold. You wouldn&rsquo;t want to sell the
last remaining item to two customers.</p>
</li>
<li>
<p>Paying out bets on an online poker site. It&rsquo;s important to ensure the same
win isn&rsquo;t paid twice.</p>
</li>
<li>
<p>Inventory management for a warehouse. Restocking an item twice without seeing
the new quantity could result in twice as much held stock as intended.</p>
</li>
<li>
<p>Financial transactions. When transferring money, it&rsquo;s important that credits
and debts on two accounts are either both applied or not applied at all.</p>
</li>
</ul>
<p>Dgraph v0.9 introduces <strong>distributed ACID transactions with synchronous
replication</strong>. What this means is that transactions work across multiple servers
each holding a part of the graph, providing <a href="https://en.wikipedia.org/wiki/ACID">ACID</a> guarantees.</p>
<p>Increasing throughput is still just a matter of bringing up additional dgraph
instances. There is no need to worry about seeing a previous database state when
querying a replica.  From the point of view of a single client, once a
transaction is committed its changes are guaranteed to be visible in all future
transactions.  These guarantees help simplify application code significantly
while providing a high level of scalability and crash resilience.</p>
<h2 id="client-libraries">Client Libraries</h2>
<p>Dgraph exposes its API via gRPC and HTTP. <em>However&hellip;</em></p>
<p>Transactions require some bookkeeping and state management on the client side.
Because of this, it&rsquo;s strongly recommended to use a client library to interact
with dgraph.</p>
<p>At the time of writing, official <a href="https://docs.dgraph.io/clients/#go">Go</a>, <a href="https://docs.dgraph.io/clients/#java">Java</a> and a
community-driven <a href="https://github.com/calummoore/dgraph-node">Javascript</a> clients are available.</p>
<p>Client libraries for other languages can be implemented on top of the gRPC or
HTTP APIs. The best way to approach this is to read the documentation about how
to use the <a href="https://docs.dgraph.io/clients/#raw-http">raw HTTP API</a> and look at the implementations for other
existing clients.</p>
<p>The examples in this blog post will use the Go client.</p>
<h4 id="a-simple-login-system">A simple login system</h4>
<p>Prior to v0.9.0 dgraph had an upsert feature which is now removed. Upsert
atomically searches and retrieves or creates and retrieves depending on whether
an entity exists or not.</p>
<p>With transactions, an explicit upsert feature is no longer required. This is
because upsert style operations can be performed atomically within a transaction.</p>
<p>So how is this done?</p>
<p>In this example, we model a simple login system, where a user has to provide an
email address and password in order to gain access to the system.</p>
<p>If the user already exists, then the password must match. If the user <em>doesn&rsquo;t</em>
yet exist, then their password should be stored for later logins.</p>
<p>It&rsquo;s important to do all of this in a transaction. If it&rsquo;s not, then the same
account might inadvertently be created twice.</p>
<p>Error checking and JSON marshalling/unmarshalling have been omitted for
brevity:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// Create a new transaction. The deferred call to Discard
</span><span style="color:#998;font-style:italic">// ensures that server-side resources are cleaned up.
</span><span style="color:#998;font-style:italic"></span>txn <span style="color:#000;font-weight:bold">:=</span> client.<span style="color:#900;font-weight:bold">NewTxn</span>()
<span style="color:#000;font-weight:bold">defer</span> txn.<span style="color:#900;font-weight:bold">Discard</span>(ctx)

<span style="color:#998;font-style:italic">// Create and execute a query to looks up an email and checks if the password
</span><span style="color:#998;font-style:italic"></span>matches.
q <span style="color:#000;font-weight:bold">:=</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">`
</span><span style="color:#d14">    {
</span><span style="color:#d14">        login_attempt(func: eq(email, %q)) {
</span><span style="color:#d14">            checkpwd(pass, %q)
</span><span style="color:#d14">        }
</span><span style="color:#d14">    }
</span><span style="color:#d14">`</span>, email, pass)
resp, err <span style="color:#000;font-weight:bold">:=</span> txn.<span style="color:#900;font-weight:bold">Query</span>(ctx, q)

<span style="color:#998;font-style:italic">// Unmarshal the response into a struct. It will be empty if the email couldn&#39;t
</span><span style="color:#998;font-style:italic">// be found. Otherwise it will contain a bool to indicate if the password matched.
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">var</span> login <span style="color:#000;font-weight:bold">struct</span> {
    Account []<span style="color:#000;font-weight:bold">struct</span> {
        Pass []<span style="color:#000;font-weight:bold">struct</span> {
            CheckPwd <span style="color:#458;font-weight:bold">bool</span> <span style="color:#d14">`json:&#34;checkpwd&#34;`</span>
        } <span style="color:#d14">`json:&#34;pass&#34;`</span>
    } <span style="color:#d14">`json:&#34;login_attempt&#34;`</span>
}
err = json.<span style="color:#900;font-weight:bold">Unmarshal</span>(resp.<span style="color:#900;font-weight:bold">GetJson</span>(), <span style="color:#000;font-weight:bold">&amp;</span>login)

<span style="color:#998;font-style:italic">// Now perform the upsert logic.
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">len</span>(login.Account) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> {
    fmt.<span style="color:#900;font-weight:bold">Println</span>(<span style="color:#d14">&#34;Account doesn&#39;t exist! Creating new account.&#34;</span>)
    mu <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">&amp;</span>protos.Mutation{
        SetJson: []<span style="color:#0086b3">byte</span>(fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">`{ &#34;email&#34;: %q, &#34;pass&#34;: %q }`</span>, email, pass)),
    }
    _, err = txn.<span style="color:#900;font-weight:bold">Mutate</span>(ctx, mu)
    <span style="color:#998;font-style:italic">// Commit the mutation, making it visible outside of the transaction.
</span><span style="color:#998;font-style:italic"></span>    err = txn.<span style="color:#900;font-weight:bold">Commit</span>(ctx)
} <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> login.Account[<span style="color:#099">0</span>].Pass[<span style="color:#099">0</span>].CheckPwd {
    fmt.<span style="color:#900;font-weight:bold">Println</span>(<span style="color:#d14">&#34;Login successful!&#34;</span>)
} <span style="color:#000;font-weight:bold">else</span> {
    fmt.<span style="color:#900;font-weight:bold">Println</span>(<span style="color:#d14">&#34;Wrong email or password.&#34;</span>)
}
</code></pre></div><h4 id="bank-account-transfers">Bank Account Transfers</h4>
<p>The classical example for database transactions is to transfer money between
two bank accounts. In this example, we have a set of bank accounts, each
represented by a node in the graph. Each node is known by a uid and has its
balance represented by a <code>bal</code> predicate.</p>
<p>This example was extracted from a tool we used when testing the correctness of
our transaction implementation. The full source is <a href="https://github.com/dgraph-io/dgraph/blob/master/contrib/integration/bank/main.go">here</a>.</p>
<p>Given the uid of two accounts, we want to transfer money from one account to
the other, i.e. reduce one balance and increase the other by the same amount.</p>
<p>It&rsquo;s important that this is done in a transaction; if it isn&rsquo;t, then two
transfers happening concurrently could result in the net balance of all
accounts changing. It could also result in double spending.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">txn <span style="color:#000;font-weight:bold">:=</span> s.dg.<span style="color:#900;font-weight:bold">NewTxn</span>()
<span style="color:#000;font-weight:bold">defer</span> txn.<span style="color:#900;font-weight:bold">Discard</span>(ctx)

<span style="color:#998;font-style:italic">// Get current balances for the two accounts.
</span><span style="color:#998;font-style:italic"></span>q <span style="color:#000;font-weight:bold">:=</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">`{both(func: uid(%s, %s)) { uid, bal }}`</span>, from, to)
resp, err <span style="color:#000;font-weight:bold">:=</span> txn.<span style="color:#900;font-weight:bold">Query</span>(ctx, q)
<span style="color:#000;font-weight:bold">type</span> Accounts <span style="color:#000;font-weight:bold">struct</span> {
    Both []Account <span style="color:#d14">`json:&#34;both&#34;`</span>
}
<span style="color:#000;font-weight:bold">var</span> a Accounts
err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Unmarshal</span>(resp.Json, <span style="color:#000;font-weight:bold">&amp;</span>a)

<span style="color:#998;font-style:italic">// Perform the transfer.
</span><span style="color:#998;font-style:italic"></span>a.Both[<span style="color:#099">0</span>].Bal <span style="color:#000;font-weight:bold">+=</span> <span style="color:#099">5</span>
a.Both[<span style="color:#099">1</span>].Bal <span style="color:#000;font-weight:bold">-=</span> <span style="color:#099">5</span>
<span style="color:#000;font-weight:bold">if</span> a.Both[<span style="color:#099">0</span>].Bal &lt; <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> a.Both[<span style="color:#099">1</span>].Bal &lt; <span style="color:#099">0</span> {
    <span style="color:#998;font-style:italic">// Abandon the transaction if there are insufficient funds.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span>
}

<span style="color:#998;font-style:italic">// Write back to dgraph.
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">var</span> mu protos.Mutation
data, err <span style="color:#000;font-weight:bold">:=</span> json.<span style="color:#900;font-weight:bold">Marshal</span>(a.Both)
mu.SetJson = data
_, err = txn.<span style="color:#900;font-weight:bold">Mutate</span>(ctx, <span style="color:#000;font-weight:bold">&amp;</span>mu)
err = txn.<span style="color:#900;font-weight:bold">Commit</span>(ctx)
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>It has historically been difficult to implement transactions in NoSQL
technologies. Notably, MongoDB has been
<a href="https://jira.mongodb.org/browse/SERVER-11500">working</a> on a
<a href="https://jira.mongodb.org/browse/SERVER-11508">solution</a> for a
<a href="https://jira.mongodb.org/browse/SERVER-2804">while</a>.</p>
<p>So implementing transactions with synchronous replication is a massive
milestone for Dgraph. With this complex but valuable feature, our community
will be able to build apps on top of dgraph without having to worry about
tricky data integrity issues!</p>


<aside class="post__references">

    <h4>References</h4><p>Top image: <a href="https://www.nasa.gov/sites/default/files/thumbnails/image/neutron_star_merger_still_3.jpg">When (Neutron) Stars Colide</a></p>
</aside>


                        </div>

                        
    <aside class="post__authors">
                <div class="tile author-tile">

    <img src="https://blog.dgraph.io/images/people/peter.jpg" class="author-tile__photo">

    <h4 class="author-tile__title">
        <a href="https://blog.dgraph.io/authors/peter/">Peter Stace</a>,
        Author
    </h4>

    <p>After Peter graduated in Computer Science in 2012, he worked on low latency
derivative trading systems. He enjoys optimising systems for efficiency and
speed. In his spare time, he enjoys cycling and drone racing.</p>


    
        <nav class="author-tile__social">

            
                <a href="https://www.linkedin.com/in/peter-stace-b34726b8/" target="_blank">
                    <i class="fab fa-linkedin"></i>
                </a>
            

            
                <a href="https://twitter.com/peterjohnstace" target="_blank">
                    <i class="fab fa-twitter"></i>
                </a>
            

            
                <a href="https://github.com/peterstace" target="_blank">
                    <i class="fab fa-github"></i>
                </a>
            

        </nav>
    

</div>

            
        
                <div class="tile author-tile">

    <img src="https://blog.dgraph.io/images/people/manish.jpg" class="author-tile__photo">

    <h4 class="author-tile__title">
        <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>,
        Editor
    </h4>

    <p>Manish is the Chief decision maker at Dgraph. He got thrust into distributed
systems right out of college, working on real time web indexing systems at
Google. He then lead various projects to consolidate and serve Knowledge Graph
right behind web search.</p>
<p>Implementing GTD and Zero Waste practices, Manish is into efficient and
minimalist living. He loves cycling, swimming and ultra light travelling.</p>


    
        <nav class="author-tile__social">

            

            
                <a href="https://twitter.com/manishrjain" target="_blank">
                    <i class="fab fa-twitter"></i>
                </a>
            

            
                <a href="https://github.com/manishrjain" target="_blank">
                    <i class="fab fa-github"></i>
                </a>
            

        </nav>
    

</div>

            
        

    </aside>



                        <div class="post__comments">

    <div id="discourse-comments"></div>

    
    <script type="text/javascript">
        DiscourseEmbed = {
            discourseUrl: "https:\/\/discuss.dgraph.io\/",
            topicId:  1962 
            };
        (function() {
            var d = document.createElement("script");
            d.type = "text/javascript";
            d.async = true;
            d.src = DiscourseEmbed.discourseUrl + "javascripts/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(d);
        })();
    </script>
    <noscript>Please enable JavaScript to view the comments on <a href="https://discuss.dgraph.io/">discuss</a>.</noscript>
    

</div>


                        <div class="modal fade" id="runnable-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <a href="#" data-dismiss="modal" class="modal-close-btn">
    Close
  </a>

  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">

      </div>
    </div>
  </div>
</div>

                    </div>
                </div>

                <div class="col-12 col-md-4 col-lg-3 offset-lg-1">
                    <div class="page-body__sidebar">

                        




<div class="post__related">

    <h3>Related Posts</h3>

    
    <div class="post">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/cassini.jpg">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Mon, Oct 9, 2017
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/bulkloader/">Loading close to 1M edges/sec into Dgraph</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/peter/">Peter Stace</a>
        
    

</div>



    	</div>

    </div>
    
    <div class="post">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/galileo-jupiter.jpg">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Mon, Aug 14, 2017
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/alice/">Making Badger Crash Resilient with ALICE</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/peter/">Peter Stace</a>
        
    

</div>



    	</div>

    </div>
    

</div>



                        


                        <aside class="post__cta">

    <h3>
        Deploy Dgraph<br>
        in Minutes
    </h3>

    <p>Dgraph does more than just simplify your workload. Discover what makes Dgraph GraphQL the best option for the job.</p>

    <a href="https://dgraph.io/downloads" class="button button--secondary">
        <span>Download</span>
        <i class=" fas fa-arrow-right"></i>
    </a>

</aside>


                    </div>
                </div>

            </div>
        </div>
    </section>

    <footer class="page-footer">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-5 col-sm-4">
        <div class="row">
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Products</h3>
            <ul>
              <li><a href="https://dgraph.io/graphql">GraphQL</a></li>
              <li><a href="https://dgraph.io/enterprise">Enterprise</a></li>
              <li><a href="https://dgraph.io/downloads">Downloads</a></li>
            </ul>
          </div>
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Learn</h3>
            <ul>
              <li><a href="https://dgraph.io/blog" target="_blank">Blog</a></li>
              <li><a href="https://tour.dgraph.io" target="_blank">Interactive Tour</a></li>
              <li><a href="https://discuss.dgraph.io" target="_blank">Forum</a></li>
              <li><a href="https://slack.dgraph.io" target="_blank">Slack</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-5 col-sm-4">
        <div class="row">
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Docs</h3>
            <ul>
              <li><a href="https://docs.dgraph.io" target="_blank">Dgraph Docs</a></li>
              <li><a href="https://graphql.dgraph.io/docs/" target="_blank">GraphQL Docs</a></li>
            </ul>
          </div>
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Company</h3>
            <ul>
              <li><a href="https://dgraph.io/about">Team</a></li>
              <li><a href="https://dgraph.io/careers">Careers</a></li>
              <li><a href="https://dgraph.io/contact">Contact</a></li>
              <li><a href="https://dgraph.io/conduct">Conduct</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3 offset-lg-1 border-above-sm">
        <div class="page-footer__cta"><a href="https://dgraph.io/downloads" title="Download" class="button button--secondary"><span>Download</span><i class="fas fa-arrow-right"></i></a></div>
        <div class="page-footer__address">
          <p>
            655 Montgomery Street, 7th Floor<br>
            San Francisco, CA 94111
          </p>
          <hr>
          <p><a href="mailto:contact@dgraph.io">contact@dgraph.io</a></p>
        </div>
      </div>
    </div>
    <div class="page-footer__social">
      <ul>
        <li><a href="https://twitter.com/dgraphlabs" target="_blank"><i class="fab fa-twitter"></i></a></li>
        <li><a href="https://github.com/dgraph-io/dgraph" target="_blank"><i class="fab fa-github"></i></a></li>
        <li><a href="https://www.youtube.com/channel/UCghE41LR8nkKFlR3IFTRO4w" target="_blank"><i class="fab fa-youtube"></i></a></li>
        <li><a href="https://slack.dgraph.io" target="_blank"><i class="fab fa-slack"></i></a></li>
        <li><a href="https://www.linkedin.com/company/dgraph-labs" target="_blank"><i class="fab fa-linkedin"></i></a></li>
      </ul>
    </div>
    <div class="page-footer__copyright">
      <p>
        <Copyright>&copy; 2017-2020 Dgraph Labs, Inc.</Copyright>
      </p>
    </div>
  </div>
</footer>

    <script src="https://blog.dgraph.io//js/clipboard.min.js"></script>
    <script
      src='https://blog.dgraph.io//js/runnable.js?29f8ba4fb8d90804cf24ff53b70192ad'
    ></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>




<script>
  window.Countly = window.Countly || {};
  Countly.q = Countly.q || [];

  Countly.q.push(['track_sessions']);
  Countly.q.push(['track_pageview']);
  (function() {
  	var cly = document.createElement('script');
  	cly.type = 'text/javascript';
  	cly.async = true;
  	cly.src = "https://dgraph.io/assets/js/unminified/stats/dgraph-stats.min.js";
  	cly.onload = function() {
      Countly.init({
        app_key: "e93284ab5e5d21ef9eb16a94516b3c1c6eba1015",
        url: "https://stats.dgraph.io",
        force_post: true,
      })
  	};
  	document.body.appendChild(cly);
  })();
</script>


<script>
$(document.links)
  .filter(function() {
    return this.hostname != window.location.hostname;
  })
  .attr("target", "_blank");
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/visibility.js/1.2.4/visibility.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
<link
  href='https://blog.dgraph.io//css/heart.css?24a50879951b2391f04750723b4a012e'
  rel="stylesheet">
<link
  href='https://blog.dgraph.io//css/github-engage.css?d60d80bf2b6a24350cdb5d834ab47e27'
  rel="stylesheet">

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"
  integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps="
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src='https://blog.dgraph.io//js/custom.js?94f0c667422b8dac293e14c9c49872e3'
></script>

<script src="//unpkg.com/@dgraph-io/community"></script>


</body>

    <script src="https://blog.dgraph.io/js/footnotes.js"></script>

</html>

