<!DOCTYPE html>

<head>
  <meta charset="utf-8">

  
  <link rel="apple-touch-icon" sizes="57x57" href="assets/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="assets/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="assets/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/images/favicons/apple-touch-icon-76x76.png">

  <link rel="apple-touch-icon" sizes="114x114" href="assets/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="assets/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicons/apple-touch-icon-180x180.png">

  <link rel="icon" type="image/png" href="assets/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="assets/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/assets/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="assets/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="assets/images/favicons/favicon-16x16.png" sizes="16x16">

  <link rel="mask-icon" href="assets/images/favicons/safari-pinned-tab.svg" color="#fe2c06">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/assets/favicons/mstile-144x144.png">
  <meta name="msapplication-config" content="/assets/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.dgraph.io/index.xml">

  
    <title>Introducing Ristretto: A High-Performance Go Cache - Dgraph Blog</title>
    <meta property='og:title' content="Introducing Ristretto: A High-Performance Go Cache - Dgraph Blog">
    <meta property="og:type" content="article">
  

  <meta property="og:url" content="https://blog.dgraph.io/post/introducing-ristretto-high-perf-go-cache/">
  
  <meta property="og:image" content="https://blog.dgraph.io/images/ristretto-3.jpg">

  <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Work+Sans:400,500,700,800" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" integrity="sha256-0rguYS0qgS6L4qVzANq4kjxPLtvnp5nn2nB5G1lWRv4=" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/default.min.css" rel="stylesheet" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js" integrity="sha256-sNPiigbfSkqUzMc5rgrdztLnneCMAp6W9wetJUZu9Zw=" crossorigin="anonymous"></script>

  <link
    href='https://blog.dgraph.io//css/runnable.css?7bbf71b4888bc97241e85bc7326a12fe'
    rel="stylesheet"
  />
  <link
    href='https://blog.dgraph.io//css/runnable-custom.css?74110b504a7b8a6e92a95279cfa96032'
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.js" integrity="sha256-x3BtPVERvw1ozPlwivuFLZoViFCeAAs1Gt6SxEedmo8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.css" integrity="sha256-7sZe9dsqyNZC9Mk+WPRB7nVvPPPXyorzm2QKqlgXC4k=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/addon/edit/closebrackets.min.js" integrity="sha256-qhu2a7DSpQaammMaLw1iruxBpxmgdw8mdQaQWQUokcY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/javascript/javascript.min.js" integrity="sha256-7Bdg/UdDMmHDPafpQDYZNPCEbnRP7eAvu+2hEoqRCXs=" crossorigin="anonymous"></script>
  

  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@3/dist/algoliasearch.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.0.0/dist/instantsearch.production.min.js" integrity="sha256-6S7q0JJs/Kx4kb/fv0oMjS855QTz5Rc2hh9AkIUjUsk=" crossorigin="anonymous"></script>
  <script src="/js/search.js"></script>

  <link
    rel="stylesheet"
    href='https://blog.dgraph.io/css/styles.css?5c8a1fe31ab0b3ec38aa8f3c97f9040d'>
  <link
    rel="stylesheet"
    href='https://blog.dgraph.io/css/custom.css?83898a52f9f9600dfde9404842bcb2d4'>

  
  
    
      <meta name="twitter:card" content="summary_large_image"/>
      <meta name="twitter:image" content="https://blog.dgraph.io/images/ristretto-3.jpg"/>
    
  

  <meta name="twitter:title" content="Introducing Ristretto: A High-Performance Go Cache"/>
  <meta name="twitter:description" content="This post made it to the top of Golang subreddit and is trending in top 10 on the front page of Hacker News. Do engage in discussion there and show us love by giving us a star.
With over six months of research and development, we&#39;re proud to announce the initial release of Ristretto: A High Performance, Concurrent, Memory-Bound Go cache. It is contention-proof, scales well and provides consistently high hit-ratios."/>
  <meta name="twitter:site" content="@dgraphlabs"/>
</head>


<body class="blog-article" data-gr-c-s-loaded="true">

  <div class="svg-holder">
    <svg xmlns="https://www.w3.org/2000/svg">
      <symbol viewBox="0 0 32 32" id="icon-chevron-down">
        <title>chevron-down</title>
        <path d="M1.352,9.793l3.089-3.07C4.678,6.49,4.957,6.371,5.28,6.371S5.883,6.49,6.12,6.723L16,16.605l9.88-9.883
          c0.237-0.232,0.517-0.352,0.84-0.352s0.603,0.119,0.84,0.352l3.089,3.07C30.882,10.03,31,10.31,31,10.641
          c0,0.327-0.118,0.609-0.352,0.847L16.84,25.276c-0.237,0.235-0.517,0.353-0.84,0.353s-0.603-0.117-0.84-0.353L1.352,11.487
          C1.118,11.25,1,10.968,1,10.641C1,10.31,1.118,10.03,1.352,9.793z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-chevron-right">
        <title>chevron-right</title>
        <polygon points="30.644,16.012 1.356,1 10.835,16.012 1.356,31 "></polygon>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-chevron-up">
        <title>chevron-up</title>
        <path d="M30.648,22.207l-3.089,3.07c-0.237,0.232-0.517,0.352-0.84,0.352s-0.603-0.119-0.84-0.352L16,15.395l-9.88,9.883
          c-0.237,0.232-0.517,0.352-0.84,0.352s-0.603-0.119-0.84-0.352l-3.089-3.07C1.118,21.97,1,21.69,1,21.359
          c0-0.327,0.118-0.609,0.352-0.847L15.16,6.724c0.237-0.235,0.517-0.353,0.84-0.353s0.603,0.117,0.84,0.353l13.809,13.789
          C30.882,20.75,31,21.032,31,21.359C31,21.69,30.882,21.97,30.648,22.207z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-comment">
        <title>comment</title>
        <path d="M6.625,1.938v3.75H27.25v15H31V1.938H6.625z M1,24.438h3.75v5.625l5.625-5.625h15V7.562H1V24.438z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-dropdown">
        <title>dropdown</title>
        <path d="M30.924,9.199c-0.164-0.422-0.574-0.643-1.027-0.643H2.105c-0.457,0-0.863,0.221-1.029,0.643
          c-0.166,0.424-0.055,0.876,0.279,1.184L15.252,23.16c0.211,0.193,0.479,0.283,0.748,0.283s0.537-0.1,0.75-0.295l13.895-12.762
          C30.979,10.077,31.09,9.623,30.924,9.199z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-facebook">
        <title>facebook</title>
        <path d="M26,1H6C3.239,1,1,3.239,1,6v19.999C1,28.761,3.237,31,6,31h10V17.875h-3.75v-3.75H16v-2.812
          c0-2.588,2.099-4.688,4.688-4.688h4.688v3.75h-4.688c-0.518,0-0.938,0.42-0.938,0.938v2.812h5.156l-0.938,3.75H19.75V31H26
          c2.761,0,5-2.239,5-5.001V6C31,3.239,28.763,1,26,1z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-folder">
        <title>folder</title>
        <path d="M30.202,8.34H13.658l-3.236-2.942c-0.178-0.161-0.407-0.249-0.646-0.249H2.117C1.589,5.149,1,5.418,1,5.947v19.788
          c0,0.527,0.589,1.117,1.117,1.117h28.085c0.528,0,0.798-0.59,0.798-1.117V9.138C31,8.61,30.73,8.34,30.202,8.34z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-google-plus">
        <title>google-plus</title>
        <g>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M10.546,14.636v3.274h5.414c-0.219,1.402-1.638,4.117-5.414,4.117
            c-3.261,0-5.918-2.699-5.918-6.027c0-3.327,2.657-6.027,5.918-6.027c1.854,0,3.095,0.791,3.804,1.473L16.94,8.95
            c-1.663-1.556-3.816-2.496-6.395-2.496C5.268,6.455,1,10.723,1,16s4.268,9.545,9.546,9.545c5.509,0,9.164-3.871,9.164-9.327
            c0-0.627-0.069-1.105-0.151-1.582H10.546z"></path>
          <polygon fill-rule="evenodd" clip-rule="evenodd" points="28.272,14.636 28.272,11.909 25.546,11.909 25.546,14.636 22.818,14.636
            22.818,17.363 25.546,17.363 25.546,20.092 28.272,20.092 28.272,17.363 31,17.363 31,14.636       "></polygon>
        </g>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-label">
        <title>label</title>
        <path d="M27.578,7.283c-0.789,0.79-2.068,0.79-2.857,0c-0.791-0.79-0.791-2.069-0.002-2.858s2.068-0.789,2.857,0
          C28.367,5.214,28.369,6.493,27.578,7.283z M30.662,3.318c-0.047-1.084-0.973-2.003-2.057-2.042l-7.629-0.274
          c-1.086-0.04-2.6,0.556-3.367,1.323L1.586,18.354c-0.768,0.767-0.768,2.023,0,2.79l9.279,9.279c0.768,0.768,2.021,0.768,2.789,0
          l16.023-16.027c0.766-0.767,1.357-2.281,1.311-3.365L30.662,3.318z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-linkedin">
        <title>linkedin</title>
        <path d="M28.188,1H3.812C2.266,1,1,2.266,1,3.812v24.375C1,29.734,2.266,31,3.812,31h24.375C29.734,31,31,29.734,31,28.188V3.812
          C31,2.266,29.734,1,28.188,1z M12.25,25.375H8.5V12.25h3.75V25.375z M10.375,10.375C9.339,10.375,8.5,9.537,8.5,8.5
          s0.839-1.875,1.875-1.875S12.25,7.463,12.25,8.5S11.411,10.375,10.375,10.375z M25.375,25.375h-3.75v-7.5
          c0-1.036-0.839-1.875-1.875-1.875s-1.875,0.839-1.875,1.875v7.5h-3.75V12.25h3.75v2.326c0.773-1.06,1.956-2.326,3.281-2.326
          c2.333,0,4.219,2.098,4.219,4.688V25.375z"></path>
      </symbol>
      <symbol viewBox="0 0 50 50" id="icon-github">
        <title>github</title>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M25 10c-8.3 0-15 6.7-15 15 0 6.6 4.3 12.2 10.3 14.2.8.1 1-.3 1-.7v-2.6c-4.2.9-5.1-2-5.1-2-.7-1.7-1.7-2.2-1.7-2.2-1.4-.9.1-.9.1-.9 1.5.1 2.3 1.5 2.3 1.5 1.3 2.3 3.5 1.6 4.4 1.2.1-1 .5-1.6 1-2-3.3-.4-6.8-1.7-6.8-7.4 0-1.6.6-3 1.5-4-.2-.4-.7-1.9.1-4 0 0 1.3-.4 4.1 1.5 1.2-.3 2.5-.5 3.8-.5 1.3 0 2.6.2 3.8.5 2.9-1.9 4.1-1.5 4.1-1.5.8 2.1.3 3.6.1 4 1 1 1.5 2.4 1.5 4 0 5.8-3.5 7-6.8 7.4.5.5 1 1.4 1 2.8v4.1c0 .4.3.9 1 .7 6-2 10.2-7.6 10.2-14.2C40 16.7 33.3 10 25 10z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-loupe">
        <title>loupe</title>
        <path d="M30.296,27.986l-3.463-3.462l0.003-0.003l-4.038-4.038c1.618-2.111,2.503-4.675,2.514-7.37
          c0.014-3.248-1.239-6.298-3.528-8.586C19.508,2.253,16.477,1,13.248,1C9.983,1,6.91,2.276,4.594,4.593
          c-2.304,2.304-3.58,5.359-3.593,8.604c-0.014,3.248,1.239,6.297,3.528,8.586c2.274,2.275,5.306,3.528,8.535,3.528
          c2.714,0,5.293-0.885,7.417-2.513l4.038,4.038l0.005-0.005l3.462,3.463c0.805,0.805,1.975,0.941,2.611,0.303
          C31.236,29.961,31.1,28.791,30.296,27.986z M5.954,20.358c-1.906-1.906-2.949-4.446-2.938-7.153c0.011-2.71,1.077-5.262,3.004-7.188
          c1.936-1.937,4.503-3.003,7.229-3.003c2.69,0,5.216,1.043,7.111,2.938c1.905,1.905,2.948,4.446,2.938,7.153
          c-0.011,2.711-1.077,5.263-3.004,7.188c-1.935,1.938-4.502,3.004-7.229,3.004C10.373,23.297,7.849,22.253,5.954,20.358z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-next">
        <title>next</title>
        <polygon points="3.168,1 3.402,1.234 18.227,16 3.227,31 13.773,31 26.137,18.636 28.834,16 26.137,13.364 13.83,1 3.166,1 "></polygon>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-01">
        <title>perk-01</title>
        <path d="M12.725,13.023c-1.627,0-2.977,1.32-2.977,2.977c0,1.627,1.32,2.977,2.977,2.977c1.658,0,2.977-1.322,2.977-2.977
          C15.671,14.372,14.351,13.023,12.725,13.023z M12.725,11.58c2.455,0,4.42,1.994,4.42,4.42c0,2.456-1.995,4.42-4.42,4.42
          s-4.45-1.965-4.45-4.42C8.274,13.543,10.27,11.58,12.725,11.58z M10.944,16c0,0.981,0.797,1.78,1.78,1.78
          c0.981,0,1.749-0.798,1.749-1.78s-0.798-1.781-1.781-1.781C11.711,14.218,10.944,15.018,10.944,16z M28.531,9.768
          c-0.153-0.214-0.431-0.214-0.584,0l-2.395,3.499c-0.153,0.246,0,0.554,0.276,0.554h0.921v8.931c0,0.275,0.215,0.459,0.461,0.459
          h2.087c0.277,0,0.461-0.213,0.461-0.459v-8.931h0.891c0.276,0,0.46-0.308,0.276-0.554L28.531,9.768z M21.226,18.24h-2.088
          c-0.276,0-0.46,0.215-0.46,0.461v4.082c0,0.277,0.214,0.461,0.46,0.461h2.088c0.276,0,0.461-0.215,0.461-0.461v-4.082
          C21.687,18.455,21.472,18.24,21.226,18.24z M25.246,16.06h-2.088c-0.276,0-0.46,0.214-0.46,0.46v6.261
          c0,0.277,0.214,0.461,0.46,0.461h2.088c0.276,0,0.46-0.215,0.46-0.461V16.52C25.736,16.276,25.522,16.06,25.246,16.06z
          M23.16,14.986h1.258v-4.204c0-1.104-0.921-2.025-2.025-2.025H3.025C1.92,8.756,1,9.677,1,10.782v10.435
          c0,1.105,0.92,2.025,2.025,2.025h14.608c-0.061-0.154-0.061-0.307-0.061-0.461v-1.258H5.112c0.03-0.123,0.03-0.246,0.03-0.367
          c0-1.135-0.92-2.057-2.056-2.057c-0.123,0-0.246,0-0.367,0.031V12.87c0.123,0.03,0.246,0.03,0.367,0.03
          c1.136,0,2.056-0.921,2.056-2.057c0-0.122,0-0.245-0.03-0.367h15.069c-0.03,0.153-0.061,0.338-0.061,0.491
          c0,1.135,0.921,2.056,2.056,2.056c0.184,0,0.337-0.031,0.521-0.061v2.088C22.854,15.018,23.007,14.986,23.16,14.986z M6.247,14.771
          c0.675,0,1.229,0.554,1.229,1.229c0,0.674-0.554,1.227-1.229,1.227c-0.674,0-1.228-0.553-1.228-1.227
          C5.02,15.325,5.573,14.771,6.247,14.771z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-02">
        <title>perk-02</title>
        <g>
          <path d="M28.748,23.826 M27.998,5.83H4.006c-0.412,0-0.75,0.338-0.75,0.75v17.247c0,0,25.426,0,25.491,0V6.58
            C28.747,6.167,28.409,5.83,27.998,5.83z M27.276,7.131v15.394H4.729V7.131H27.276"></path>
          <path d="M30.995,25.232v-0.469H18.519c-0.048,0.264-0.282,0.469-0.576,0.469h-3.891c-0.294,0-0.528-0.205-0.577-0.469H1v0.469
            h0.005l1.5,0.938H29.5l1.5-0.938H30.995z"></path>
        </g>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-03">
        <title>perk-03</title>
        <path d="M3.217,20.503c-0.336,0-0.605-0.269-0.605-0.605V6.491c0-0.336,0.27-0.605,0.605-0.605h25.638
          c0.336,0,0.605,0.27,0.605,0.605v13.373c0,0.336-0.27,0.605-0.605,0.605H3.217V20.503z M29.122,4.274H2.881
          C1.84,4.274,1,5.114,1,6.155v15.558c0,1.041,0.84,1.881,1.881,1.881h10.752v1.848l-2.621,1.21c-0.537,0.234-0.369,1.074,0.234,1.074
          h9.609c0.605,0,0.773-0.807,0.234-1.074l-2.621-1.21v-1.848h10.65c1.041,0,1.881-0.84,1.881-1.881V6.155
          C31.005,5.114,30.165,4.274,29.122,4.274z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-04">
        <title>perk-04</title>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M27,2.8C27,1.806,26.328,1,25.5,1h-19C5.672,1,5,1.806,5,2.8v26.4
          C5,30.194,5.672,31,6.5,31h19c0.828,0,1.5-0.806,1.5-1.8V2.8z M16,30.359c-0.483,0-0.875-0.392-0.875-0.875s0.392-0.875,0.875-0.875
          s0.875,0.392,0.875,0.875S16.483,30.359,16,30.359z M25,28H7V4h18V28z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-05">
        <title>perk-05</title>
        <g>
          <path d="M10.24,15.323l2.318-7.521l4.955,11.268l1.096-3.81h11.934c0.625-2.192,0.453-3.82,0.377-4.386
            c-0.303-2.285-1.537-6.543-6.539-7.528c-0.748-0.147-1.447-0.217-2.098-0.227c-0.049,0-0.096-0.002-0.145-0.002
            c-0.002,0-0.002,0-0.004,0c-3.473-0.004-5.527,2.149-6.146,2.752c-0.619-0.604-2.674-2.756-6.148-2.752c-0.002,0-0.002,0-0.004,0
            c-0.047,0-0.096,0-0.143,0.002c-0.65,0.009-1.35,0.079-2.098,0.227c-5.002,0.985-6.35,5.484-6.539,7.528
            c-0.049,0.514-0.221,2.184,0.451,4.448H10.24z"></path>
          <path d="M19.943,17.032l-2.082,7.232L12.85,12.867l-1.305,4.228H2.168c1.6,3.537,5.32,7.974,13.82,11.787
            c8.602-3.861,12.33-8.312,13.906-11.852h-9.951V17.032z"></path>
        </g>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-06">
        <title>perk-06</title>
        <path d="M16.464,27.867c7.343,0,9.74-7.942,9.74-7.942S31,18.127,31,13.63c0-2.997-1.649-6.144-5.695-6.144
          c-5.694,0-7.643,3.896-6.443,6.594c-6.595-0.899-7.644,4.047-7.943,5.395c-0.6-1.348-1.199-2.997-3.297-4.795
          c-1.798-1.649-2.248-3.897-2.548-4.496c-0.3-0.75,0.45-1.199,1.199-0.45c0.449,0.299,2.098,0.299,4.196-1.648
          c0.3-0.15,0.3-0.6,0.149-0.899C10.169,6.587,9.42,5.688,8.67,5.088C7.771,4.339,7.172,3.74,5.823,3.889
          c-1.199,0.15-2.248,1.199-3.147,1.948c-1.349,1.199-1.799,2.997-1.648,5.695c0.149,1.948,0.3,5.694,2.248,10.49
          c1.198,3.298,4.845,5.745,5.545,5.845C11.258,28.467,16.464,27.867,16.464,27.867z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-07">
        <title>perk-07</title>
        <g>
          <path d="M22.315,20.725c1.791-1.791,4.707-1.793,6.499,0l0.025,0.029c0.136,0.145,0.376,0.148,0.523,0.006
            c0.146-0.145,0.149-0.375,0.005-0.521c-0.007-0.012-0.019-0.025-0.031-0.037c-2.081-2.078-5.464-2.078-7.543,0
            c-0.144,0.145-0.144,0.379,0,0.523S22.171,20.869,22.315,20.725z"></path>
          <path d="M27.689,21.904c0.133,0.146,0.377,0.15,0.522,0.006c0.146-0.143,0.147-0.377,0.006-0.523
            c-0.009-0.012-0.02-0.021-0.032-0.033c-1.445-1.447-3.799-1.447-5.244,0c-0.144,0.145-0.144,0.377,0,0.521
            c0.146,0.145,0.377,0.145,0.521,0c1.158-1.158,3.042-1.156,4.2,0.002L27.689,21.904z"></path>
          <path d="M26.596,22.992c0.138,0.139,0.376,0.152,0.523,0.012s0.152-0.375,0.012-0.523c0.002,0-0.014-0.021-0.031-0.039
            c-0.846-0.846-2.22-0.844-3.065,0c-0.146,0.146-0.144,0.379,0,0.523c0.146,0.145,0.378,0.145,0.523,0
            c0.553-0.553,1.449-0.557,2.007-0.012C26.573,22.967,26.584,22.98,26.596,22.992z"></path>
          <path d="M26.095,23.799c0,0.688-1.034,0.688-1.034,0C25.061,23.109,26.095,23.109,26.095,23.799"></path>
          <path d="M30.344,28.088c0,0.256-0.207,0.463-0.461,0.463h-0.669v-2.191h0.669c0.254,0,0.461,0.207,0.461,0.463V28.088z
            M29.883,25.703h-0.669v-0.014c0-0.053-0.003-0.105-0.007-0.158c-0.014-0.135-0.126-0.236-0.264-0.236h-6.636
            c-0.135,0-0.249,0.104-0.263,0.236c-0.006,0.053-0.007,0.105-0.007,0.158v3.061c0,0.799,0.593,1.459,1.361,1.566
            c0.028,0.012,0.058,0.016,0.09,0.016c0.115,0,0.21,0.096,0.21,0.211c0,0.146,0.119,0.266,0.264,0.266h3.323
            c0.146,0,0.263-0.119,0.263-0.266c0-0.115,0.095-0.211,0.211-0.211c0.031,0,0.061-0.004,0.089-0.016
            c0.614-0.086,1.116-0.525,1.294-1.105h0.736c0.618,0,1.121-0.504,1.121-1.121v-1.266C31.004,26.203,30.5,25.703,29.883,25.703z"></path>
          <path d="M12.34,29.51c-0.026,0.24-0.229,0.318-0.476,0.318H9.627c-0.247,0-0.448-0.078-0.475-0.318H1
            c0,0.715,0.26,1.293,0.974,1.293H19.53c0.714,0,0.958-0.578,0.958-1.293H12.34z"></path>
          <path d="M3.876,18.982h13.738v8.627H3.876V18.982z M18.183,28.887c0.392,0,0.709-0.318,0.709-0.711v-9.762
            c0-0.393-0.317-0.711-0.709-0.711H3.308c-0.392,0-0.711,0.318-0.711,0.711v9.762c0,0.393,0.317,0.711,0.711,0.711H18.183z"></path>
          <path d="M1.167,10.477c0,0.02,0,0.037,0,0.055c0.002,0.067,0.035,0.126,0.084,0.165c0.064,0.075,0.161,0.123,0.269,0.123
            c0.537,0,0.789,0.11,1.081,0.24c0.319,0.141,0.681,0.3,1.366,0.3c0.687,0,1.048-0.159,1.367-0.3c0.291-0.128,0.544-0.24,1.081-0.24
            c0.536,0,0.789,0.11,1.08,0.24c0.319,0.141,0.682,0.3,1.367,0.3c0.687,0,1.048-0.159,1.367-0.3c0.291-0.128,0.544-0.24,1.081-0.24
            c0.536,0,0.789,0.11,1.08,0.24c0.319,0.141,0.681,0.3,1.367,0.3c0.686,0,1.048-0.159,1.367-0.3c0.291-0.128,0.544-0.24,1.08-0.24
            c0.537,0,0.79,0.11,1.081,0.24c0.319,0.141,0.681,0.3,1.367,0.3c0.686,0,1.047-0.159,1.366-0.3c0.292-0.128,0.544-0.24,1.081-0.24
            s0.79,0.11,1.081,0.24c0.317,0.141,0.681,0.3,1.367,0.3c0.686,0,1.047-0.159,1.366-0.3c0.283-0.124,0.528-0.233,1.035-0.24
            c0.506,0.007,0.753,0.114,1.035,0.24c0.283,0.124,0.601,0.265,1.147,0.295v0.007c0.037,0,0.074-0.002,0.109-0.002
            c0.035,0.002,0.071,0.002,0.108,0.002v-0.007c0.548-0.03,0.865-0.171,1.147-0.295c0.293-0.128,0.544-0.24,1.083-0.24
            c0.194,0,0.353-0.158,0.353-0.354c0-0.195-0.158-0.354-0.353-0.354c-0.687,0-1.05,0.159-1.367,0.3
            c-0.271,0.119-0.509,0.225-0.972,0.239c-0.464-0.015-0.7-0.12-0.973-0.239c-0.298-0.131-0.633-0.278-1.238-0.298
            c-0.013-0.002-0.024-0.002-0.037-0.002c-0.016,0-0.029,0-0.045,0c-0.015,0-0.03,0-0.046,0c-0.013,0-0.024,0-0.037,0.002
            c-0.604,0.02-0.94,0.167-1.238,0.298c-0.292,0.13-0.544,0.24-1.081,0.24s-0.79-0.11-1.083-0.24
            c-0.181-0.079-0.373-0.164-0.633-0.225c-0.099-0.034-0.2-0.068-0.308-0.105c-0.216-0.071-0.454-0.152-0.735-0.25
            c0.198-0.348,0.372-0.724,0.521-1.12c0.227-0.604,0.398-1.265,0.509-1.963c0.07-0.437,0.107-0.832,0.126-1.16
            c1.622,1.993,3.778,2.423,3.778,2.423c-0.174-1.079-0.671-1.884-1.551-2.736c-0.178-0.172-0.354-0.323-0.527-0.456
            c1.669,0.618,3.394,0.535,3.394,0.535c-0.258-0.672-0.84-1.107-1.837-1.502c-0.509-0.202-1.002-0.321-1.451-0.386
            c1.229-0.786,1.819-1.767,1.819-1.767c-0.912-0.177-1.703-0.007-2.647,0.463c-0.47,0.235-0.839,0.5-1.128,0.764
            c-1.239-1.613-2.737-1.734-2.737-1.734c0.277,0.916,0.511,1.463,1.178,2.125c0.01,0.01,0.019,0.019,0.029,0.029
            c-2.442-0.321-4.262,0.816-4.262,0.816c0.815,0.635,1.687,0.864,2.86,0.874c0.258,0.002,0.5-0.013,0.726-0.039
            c-1.556,0.788-2.478,2.066-2.478,2.066c0.786,0.241,1.536,0.102,2.483-0.353c0.693-0.333,1.202-0.748,1.568-1.133
            c-0.062,0.978-0.293,2.59-1.116,3.978c-0.554-0.216-1.24-0.502-2.124-0.903c-4.603-2.09-5.912-5.385-6.542-6.969
            c-0.045-0.118-0.089-0.227-0.13-0.325c-0.033-0.082-0.113-0.134-0.203-0.134H7.195c-0.095,0-0.179,0.061-0.209,0.151
            C6.858,1.768,6.676,2.392,6.442,3.229C5.979,4.894,4.894,6.247,4.063,7.087C3.158,8.005,2.35,8.532,2.344,8.537
            c-0.854,0.545-1.165,1.35-1.175,1.913c0,0.007-0.002,0.012-0.002,0.021C1.167,10.471,1.167,10.474,1.167,10.477z"></path>
          <path d="M1.521,12.502c0.536,0,0.789,0.11,1.08,0.24c0.319,0.141,0.682,0.3,1.367,0.3c0.687,0,1.048-0.159,1.367-0.3
            c0.291-0.13,0.544-0.24,1.08-0.24c0.537,0,0.79,0.11,1.081,0.24c0.319,0.141,0.681,0.3,1.367,0.3c0.686,0,1.048-0.159,1.367-0.3
            c0.291-0.13,0.544-0.24,1.08-0.24c0.537,0,0.79,0.11,1.081,0.24c0.319,0.141,0.681,0.3,1.367,0.3c0.686,0,1.047-0.159,1.366-0.3
            c0.292-0.13,0.544-0.24,1.081-0.24s0.79,0.11,1.081,0.24c0.319,0.141,0.681,0.3,1.367,0.3c0.686,0,1.047-0.159,1.366-0.3
            c0.291-0.13,0.544-0.24,1.081-0.24s0.79,0.11,1.081,0.24c0.317,0.141,0.681,0.3,1.366,0.3c0.687,0,1.048-0.159,1.367-0.3
            c0.269-0.119,0.504-0.223,0.958-0.238c0.011,0.002,0.021,0.002,0.031,0.002c0.537,0,0.79,0.11,1.081,0.24
            c0.282,0.124,0.601,0.265,1.147,0.294v0.006c0.037,0,0.074,0,0.109-0.002c0.035,0.002,0.071,0.002,0.108,0.002v-0.006
            c0.548-0.029,0.865-0.17,1.147-0.294c0.293-0.128,0.544-0.24,1.083-0.24c0.194,0,0.353-0.158,0.353-0.354
            c0-0.195-0.158-0.353-0.353-0.353c-0.687,0-1.05,0.159-1.367,0.299c-0.272,0.12-0.509,0.225-0.972,0.239
            c-0.464-0.015-0.7-0.119-0.973-0.239c-0.292-0.13-0.621-0.273-1.205-0.296c-0.021-0.005-0.046-0.007-0.068-0.007
            c-0.687,0-1.048,0.159-1.367,0.3c-0.292,0.13-0.544,0.24-1.081,0.24c-0.536,0-0.789-0.11-1.082-0.24
            c-0.319-0.141-0.681-0.3-1.367-0.3c-0.686,0-1.047,0.159-1.366,0.3c-0.292,0.13-0.544,0.24-1.081,0.24s-0.79-0.11-1.081-0.24
            c-0.319-0.141-0.681-0.3-1.367-0.3c-0.686,0-1.047,0.159-1.366,0.3c-0.292,0.13-0.544,0.24-1.081,0.24s-0.79-0.11-1.081-0.24
            c-0.319-0.141-0.681-0.3-1.366-0.3c-0.687,0-1.048,0.159-1.367,0.3c-0.291,0.13-0.544,0.24-1.081,0.24s-0.789-0.11-1.081-0.24
            c-0.319-0.141-0.681-0.3-1.366-0.3c-0.687,0-1.048,0.159-1.367,0.3c-0.291,0.13-0.544,0.24-1.081,0.24s-0.789-0.11-1.08-0.24
            c-0.319-0.141-0.682-0.3-1.367-0.3c-0.195,0-0.354,0.157-0.354,0.354C1.167,12.344,1.326,12.502,1.521,12.502z"></path>
          <path d="M23.536,14.723c0.687,0,1.048-0.159,1.367-0.3c0.277-0.122,0.518-0.229,1.002-0.238c0.001,0,0.003,0,0.005,0
            c0.537,0,0.79,0.112,1.081,0.24c0.282,0.125,0.6,0.265,1.147,0.295v0.007c0.037,0,0.073,0,0.108-0.002
            c0.035,0.002,0.072,0.002,0.109,0.002V14.72c0.547-0.03,0.864-0.17,1.147-0.295c0.293-0.128,0.544-0.24,1.082-0.24
            c0.195,0,0.353-0.158,0.353-0.354c0-0.195-0.157-0.354-0.353-0.354c-0.686,0-1.049,0.159-1.366,0.3
            c-0.272,0.119-0.509,0.225-0.973,0.239c-0.463-0.015-0.7-0.12-0.972-0.239c-0.3-0.131-0.639-0.28-1.249-0.298
            c-0.015-0.002-0.028-0.004-0.043-0.004c-0.686,0-1.049,0.16-1.366,0.301c-0.291,0.128-0.544,0.24-1.081,0.24
            s-0.789-0.112-1.083-0.24c-0.317-0.141-0.681-0.301-1.366-0.301c-0.687,0-1.048,0.16-1.367,0.301
            c-0.291,0.128-0.544,0.24-1.081,0.24c-0.536,0-0.789-0.112-1.08-0.24c-0.319-0.141-0.681-0.301-1.367-0.301
            s-1.048,0.16-1.367,0.301c-0.291,0.128-0.544,0.24-1.08,0.24c-0.537,0-0.79-0.112-1.081-0.24c-0.319-0.141-0.681-0.301-1.367-0.301
            c-0.686,0-1.047,0.16-1.366,0.301c-0.292,0.128-0.544,0.24-1.081,0.24s-0.79-0.112-1.081-0.24
            c-0.319-0.141-0.681-0.301-1.367-0.301c-0.686,0-1.047,0.16-1.366,0.301c-0.292,0.128-0.544,0.24-1.081,0.24
            c-0.539,0-0.79-0.112-1.081-0.24c-0.319-0.141-0.681-0.301-1.366-0.301c-0.195,0-0.354,0.158-0.354,0.354
            c0,0.195,0.157,0.353,0.354,0.353c0.536,0,0.789,0.11,1.08,0.24c0.319,0.141,0.681,0.301,1.367,0.301
            c0.686,0,1.048-0.16,1.367-0.301c0.291-0.128,0.544-0.24,1.08-0.24c0.537,0,0.79,0.11,1.081,0.24
            c0.319,0.141,0.681,0.301,1.367,0.301c0.686,0,1.047-0.16,1.366-0.301c0.292-0.128,0.544-0.24,1.083-0.24
            c0.537,0,0.789,0.11,1.081,0.24c0.319,0.141,0.681,0.301,1.366,0.301c0.687,0,1.048-0.16,1.367-0.301
            c0.291-0.128,0.544-0.24,1.081-0.24s0.789,0.11,1.081,0.24c0.319,0.141,0.681,0.301,1.366,0.301c0.687,0,1.048-0.16,1.367-0.301
            c0.291-0.128,0.544-0.24,1.081-0.24c0.536,0,0.789,0.11,1.08,0.24C22.488,14.564,22.851,14.723,23.536,14.723z"></path>
        </g>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-perk-08">
        <title>perk-08</title>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.386,30.538L7.993,25.95c-1.231,0.708-2.263,1.089-2.604,0.739H5.381
          c-0.39-0.378,0.105-1.576,0.941-2.954l-4.936-1.498c-0.319-0.181-0.497-0.468-0.312-0.646l0.737-0.645
          c0.303-0.158,0.655-0.314,1-0.306l5.667,0.025c0.586-0.745,1.164-1.404,1.637-1.876l5.153-5.15l-0.956-0.957L4.124,10.681
          c-1.226-0.25-2.471-0.29-1.789-1.295l0.622-0.832c0.378-0.506,1.092-0.808,1.724-0.808h16.488l4.434-4.43
          c1.912-1.92,4.18-2.773,5.047-1.898h0.011c0.867,0.868,0.017,3.135-1.903,5.055l-4.433,4.433v16.852
          c0,0.631-0.304,1.348-0.812,1.726l-0.831,0.622c-1.004,0.679-1.045-0.566-1.293-1.792l-2.104-10.65l-0.858-0.859l-5.15,5.15
          c-0.559,0.564-1.396,1.276-2.315,1.981l0.022,5.178c0.009,0.348-0.147,0.698-0.309,1.001L10.03,30.85
          C9.853,31.039,9.569,30.861,9.386,30.538z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-pin">
        <title>pin</title>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M16,16c3.106,0,5.625-2.519,5.625-5.625S19.106,4.75,16,4.75
          s-5.625,2.519-5.625,5.625S12.894,16,16,16z M16,31c0,0,11.25-10.242,11.25-19.688C27.25,5.617,22.213,1,16,1
          S4.75,5.617,4.75,11.312C4.75,20.758,16,31,16,31z"></path>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-previous">
        <title>previous</title>
        <polygon points="28.831,31 28.598,30.766 13.773,16 28.773,1 18.227,1 5.863,13.364 3.166,16 5.863,18.635 18.17,31 28.834,31 "></polygon>
      </symbol>
      <symbol viewBox="0 0 32 32" id="icon-twitter">
        <title>twitter</title>
        <path d="M31,6.696c-1.103,0.489-2.291,0.82-3.536,0.969c1.271-0.762,2.247-1.968,2.708-3.404c-1.189,0.705-2.508,1.218-3.909,1.493
          c-1.122-1.196-2.723-1.943-4.493-1.943c-3.398,0-6.154,2.755-6.154,6.154c0,0.483,0.055,0.953,0.159,1.402
          C10.66,11.111,6.125,8.66,3.089,4.937C2.561,5.846,2.256,6.902,2.256,8.031c0,2.135,1.086,4.019,2.737,5.123
          c-1.009-0.031-1.957-0.309-2.786-0.77c-0.002,0.025-0.002,0.052-0.002,0.078c0,2.982,2.122,5.469,4.937,6.034
          c-0.517,0.142-1.061,0.217-1.622,0.217c-0.396,0-0.782-0.039-1.158-0.112c0.784,2.444,3.057,4.225,5.75,4.274
          c-2.105,1.651-4.761,2.635-7.645,2.635c-0.496,0-0.985-0.029-1.467-0.086c2.723,1.746,5.958,2.765,9.434,2.765
          c11.321,0,17.512-9.379,17.512-17.512c0-0.268-0.005-0.533-0.018-0.796C29.131,9.014,30.174,7.93,31,6.696L31,6.696z"></path>
      </symbol>
    </svg>
  </div>
  <header id="page-header" class="page-header">
	<div class="container">
	  <div class="row">
		<div class="col-12 offset-0 col-md-10 offset-md-1">
		  <figure class="page-logo"><a href="/"><img src="/images/logo.svg" alt="Dgraph Logo"></a></figure>
				  
			<span class="topnav-stargazers-wrapper">
			  <a href="https://github.com/dgraph-io/dgraph" data-show-count="true" aria-label="Star Dgraph on GitHub" class="github-button">Star</a>
			</span>
		  
  
		  	<span 
				onclick="toggleVisibility()"  
			  	class="search-button pull-right button button-dgraph-site button--outline"
			>
			<i class="fa fa-search" aria-hidden="true"></i>
		  </span>
  
		  <a
			  href="https://dgraph.io/"
			  title="Dgraph Website"
			  class="button button-dgraph-site button--outline pull-right"
		  >
			Dgraph.io
		  </a>
		</div>
	  </div>

	  <div id="searchbox"></div>

	</div>
  
	<script>
		createSearch();
	</script>
  </header>
  
  
  <section class="page-intro page-intro--blog-article">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 offset-xs-0 col-md-10 offset-md-1">
          <header class="page-intro__header">
            <div class="article__meta">
              <span class="article__meta-item article__date">
                
                  Thu, Sep 19, 2019
                 by
                Karl McGuire


              </span>
              <div class="share">
                <ul class="share__list">
                  
                  <li class="share__item">
                    <a href="https://twitter.com/share?text=Introducing%20Ristretto%3a%20A%20High-Performance%20Go%20Cache&amp;url=https%3a%2f%2fblog.dgraph.io%2fpost%2fintroducing-ristretto-high-perf-go-cache%2f&amp;via=dgraphlabs" class="share__link">
                      <svg class="icon share__icon share__icon--twitter">
                        <use xlink:href="#icon-twitter" xmlns:xlink="https://www.w3.org/1999/xlink"></use>
                      </svg>
                      Tweet this
                    </a>
                  </li>
                  
                </ul>
              </div>
            </div>
            <h1 class="page-intro__title page-intro__title--blog">Introducing Ristretto: A High-Performance Go Cache</h1>
          </header>
        </div>
      </div>
    </div>
  </section>
  
  <div class="page-content">
    <div class="container">
      <div class="row">
        <div class="col-xs-12 offset-xs-0 col-md-10 offset-md-1">
          <img
            class="main__image"
            src="https://blog.dgraph.io/images/ristretto-3.jpg"
          >
          <div class="article-content"><p><strong>This post made it to the top of Golang <a href="https://www.reddit.com/r/golang/comments/d6taoq/introducing_ristretto_a_highperformance_go_cache/">subreddit</a> and is trending in top 10
on the front page of <a href="https://news.ycombinator.com/item?id=21023949">Hacker News</a>. Do engage in discussion there and show
us love by giving us a <a href="https://github.com/dgraph-io/dgraph">star</a>.</strong></p>
<p>With over six months of research and development, we're proud to announce the
initial release of <strong><a href="https://github.com/dgraph-io/ristretto">Ristretto</a>: A High Performance, Concurrent, Memory-Bound
Go cache.</strong> It is contention-proof, scales well and provides consistently high
hit-ratios.</p>
<p>You can now also watch the talk Manish gave at the latest Go Bangalore meetup!</p>
<!-- raw HTML omitted -->
<h3 id="preface">Preface</h3>
<p>It all started with needing a memory-bound, concurrent Go cache in <a href="https://github.com/dgraph-io/dgraph">Dgraph</a>.
We looked around for a solution, but we couldn't find a great one. We then tried
using a sharded map, with shard eviction to release memory, which caused us
memory issues. We then repurposed Groupcache's <a href="https://github.com/golang/groupcache/blob/master/lru/lru.go">LRU</a>, using mutex locks for
thread safety. After having it around for a year, we noticed that the cache
suffered from severe contention. A <a href="https://github.com/dgraph-io/dgraph/commit/b9990f4619b64615c2c18bb7627d198b4397109c">commit</a> to remove that cache caused our
query latency to dramatically improve by 5-10x. <strong>In essence, our cache was
slowing us down!</strong></p>
<p>We concluded that the concurrent cache story in Go is broken and must be fixed.
In March, we wrote about the <a href="https://blog.dgraph.io/post/caching-in-go/">State of Caching in Go</a>, mentioning the
problem of databases and systems requiring a smart memory-bound cache which can
scale to the multi-threaded environment Go programs find themselves in. In
particular, we set these as the requirements for the cache:</p>
<ol>
<li>Concurrent</li>
<li>High cache-hit ratio</li>
<li>Memory-bounded (limit to configurable max memory usage)</li>
<li>Scale well as the number of cores and goroutines increases</li>
<li>Scale well under non-random key access distribution (e.g. Zipf).</li>
</ol>
<p>After publishing the <a href="https://blog.dgraph.io/post/caching-in-go/">blog post</a>, we built a team to address the challenges mentioned
therein and create a Go cache library worthy of being compared to non-Go cache
implementations. In particular, <a href="https://github.com/ben-manes/caffeine">Caffeine</a> which is a high performance,
near-optimal caching library based on Java 8. It is being used by many Java-based
databases, like Cassandra, HBase, and Neo4j. There's an article about the design
of Caffeine <a href="http://highscalability.com/blog/2016/1/25/design-of-a-modern-cache.html">here</a>.</p>
<h3 id="ristretto-better-half-of-espresso">Ristretto: Better Half of Espresso</h3>
<p>We have since <a href="/refs/bp_wrapper.pdf">read</a> <a href="/refs/Adaptive%20Software%20Cache%20Management.pdf">the</a> <a href="/refs/TinyLFU%20-%20A%20Highly%20Efficient%20Cache%20Admission%20Policy.pdf">literature</a>, extensively tested
implementations and discussed every variable there is to consider in writing a
cache library. And today, we are proud to announce that it is ready for the
wider Go community to use and experiment with.</p>
<p>Before we begin explaining the design of <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>, here's a code snippet which shows how to
use it:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">main</span>() {
	cache, err <span style="color:#000;font-weight:bold">:=</span> ristretto.<span style="color:#900;font-weight:bold">NewCache</span>(<span style="color:#000;font-weight:bold">&amp;</span>ristretto.Config{
		NumCounters: <span style="color:#099">1e7</span>,     <span style="color:#998;font-style:italic">// Num keys to track frequency of (10M).
</span><span style="color:#998;font-style:italic"></span>		MaxCost:     <span style="color:#099">1</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#099">30</span>, <span style="color:#998;font-style:italic">// Maximum cost of cache (1GB).
</span><span style="color:#998;font-style:italic"></span>		BufferItems: <span style="color:#099">64</span>,      <span style="color:#998;font-style:italic">// Number of keys per Get buffer.
</span><span style="color:#998;font-style:italic"></span>	})
	<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
		<span style="color:#0086b3">panic</span>(err)
	}

	cache.<span style="color:#900;font-weight:bold">Set</span>(<span style="color:#d14">&#34;key&#34;</span>, <span style="color:#d14">&#34;value&#34;</span>, <span style="color:#099">1</span>) <span style="color:#998;font-style:italic">// set a value
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// wait for value to pass through buffers
</span><span style="color:#998;font-style:italic"></span>	time.<span style="color:#900;font-weight:bold">Sleep</span>(<span style="color:#099">10</span> <span style="color:#000;font-weight:bold">*</span> time.Millisecond)

	value, found <span style="color:#000;font-weight:bold">:=</span> cache.<span style="color:#900;font-weight:bold">Get</span>(<span style="color:#d14">&#34;key&#34;</span>)
	<span style="color:#000;font-weight:bold">if</span> !found {
		<span style="color:#0086b3">panic</span>(<span style="color:#d14">&#34;missing value&#34;</span>)
	}
	fmt.<span style="color:#900;font-weight:bold">Println</span>(value)
	cache.<span style="color:#900;font-weight:bold">Del</span>(<span style="color:#d14">&#34;key&#34;</span>)
}</code></pre></div>
<h4 id="guiding-principles">Guiding Principles</h4>
<p><a href="https://github.com/dgraph-io/ristretto">Ristretto</a> is built on three guiding principles:</p>
<ol>
<li>Fast Accesses</li>
<li>High Concurrency and Contention Resistance</li>
<li>Memory Bounding.</li>
</ol>
<p>In this blog post, we'll discuss these three principles and how we achieved
them in Ristretto.</p>
<h3 id="fast-access">Fast Access</h3>
<p>As much as we love Go and its opinionated stance on features, some of Go design
decisions prevented us from squeezing out all the performance we wanted to. The
most notable one is Go's concurrency model. Due to the focus on CSP, most other
forms of atomic operations have been neglected. This makes it hard to implement
lock-free structures that would be useful in a cache library. For example, Go
<a href="https://groups.google.com/d/msg/golang-nuts/M9kF6Tdh2Vo/3tLSFYYOGgAJ">does not</a> provide thread-local storage.</p>
<p>At its core, a cache is a hash map with rules about what goes in and what goes
out. If the hash map doesn't perform well, then the whole cache will suffer.
As opposed to Java, Go does not have a lockless concurrent hashmap. Instead,
thread safety in Go is achieved via explicitly acquiring mutex locks.</p>
<p>We experimented with multiple implementations (using the <code>store</code> interface
within Ristretto) and found <code>sync.Map</code> performs well for read-heavy workloads
but deteriorates for write workloads. Considering there's no thread-local
storage, <strong>we found the best overall performance with sharded mutex-wrapped Go
maps.</strong> In particular, we chose to use 256 shards to ensure that this would
perform well even with a 64-core server.</p>
<p>With a shard based approach, we also needed to find a quick way to calculate
which shard a key should go in. This requirement and the concern about long keys
consuming too much memory led us to using <code>uint64</code> for keys, instead
of storing the entire key.  The rationale was that we'll need the hash of the
key in multiple places and doing it once at entry allowed us to reuse that hash,
avoiding any more computation.</p>
<p><strong>To generate a fast hash, we borrowed <a href="https://github.com/dgraph-io/ristretto/blob/master/z/rtutil.go#L42-L44">runtime.memhash</a> from Go Runtime.</strong>
This function uses assembly code to quickly generate a hash. Note that the hash
has a randomizer that is initialized whenever the process starts, which means
the same key would not generate the same hash on the next process run. But,
that's alright for a non-persistent cache. In our <a href="https://github.com/dgraph-io/ristretto/blob/master/z/rtutil_test.go#L11-L44">experiments</a>, we found that it can
hash 64-byte keys in under 10ns.</p>
<pre><code>BenchmarkMemHash-32 200000000	 8.88 ns/op
BenchmarkFarm-32    100000000	 17.9 ns/op
BenchmarkSip-32      30000000	 41.1 ns/op
BenchmarkFnv-32      20000000	 70.6 ns/op
</code></pre><p>We then used this hash as not only the stored key but also to figure out the
shard the key should go into. <em>This does introduce a chance of key collision,
that's something we plan to deal with later.</em></p>
<h3 id="concurrency-and-contention-resistance">Concurrency and Contention Resistance</h3>
<p>Achieving high hit ratios requires managing metadata about what's present in the
cache and what <em>should</em> be present in the cache. This becomes very hard when
balancing the performance and scalability of the cache across goroutines. Luckily,
there's a <a href="/refs/bp_wrapper.pdf">paper</a> called <em>BP-Wrapper</em> written about a system framework making any replacement
algorithms almost lock contention-free. The paper describes two ways to mitigate
contention: <em>prefetching</em> and <em>batching</em>. We only use batching.</p>
<p>Batching works pretty much how you'd think. <strong>Rather than acquiring a mutex lock
for every metadata mutation, we wait for a ring buffer to fill up before we
acquire a mutex and process the mutations.</strong> As described in
the paper, this lowers contention considerably with little overhead.</p>
<p>We apply this method for all <code>Gets</code> and <code>Sets</code> to the cache.</p>
<h4 id="gets">Gets</h4>
<p>All Gets to the cache are, of course, immediately serviced. The hard part is to
capture the Get, so we can keep track of the key access. In an LRU cache,
typically a key would be placed at the head of a linked list. In our LFU based
cache, we need to increment an item's hit counter. Both operations require
thread-safe access to a cache global struct. <a href="/refs/bp_wrapper.pdf">BP-Wrapper</a> suggests using
batching to process the hit counter increments, but the question is how do we
implement this batching process, without acquiring yet another lock.</p>
<p>This might sound like a perfect use case of Go channels, and it is.
Unfortunately, the throughput performance of channels prevented us from using
them. <strong>Instead, we devised a nifty way to use <code>sync.Pool</code> to implement striped,
lossy <a href="https://github.com/dgraph-io/ristretto/blob/master/ring.go#L99-L104">ring buffers</a></strong> that have great performance with little loss of data.</p>
<p>Any item stored in the Pool may be removed automatically at any time
<a href="https://golang.org/pkg/sync/#Pool">without</a> notification. <em>That introduces one level of lossy behavior.</em>
Each item in Pool is effectively a batch of keys. When the batch fills up, it
gets pushed to a channel. The channel size is deliberately kept small to avoid
consuming too many CPU cycles to process it. If the channel is full, the batch is dropped.
<em>This introduces a secondary level of lossy behavior.</em> A goroutine picks up this
batch from the internal channel and processes the keys, updating their hit
counter.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#900;font-weight:bold">AddToLossyBuffer</span>(key):
  stripe <span style="color:#000;font-weight:bold">:=</span> b.pool.<span style="color:#900;font-weight:bold">Get</span>().(<span style="color:#000;font-weight:bold">*</span>ringStripe)
  stripe.<span style="color:#900;font-weight:bold">Push</span>(key)
  b.pool.<span style="color:#900;font-weight:bold">Put</span>(stripe)

Once buffer fills up, push to channel:
  <span style="color:#000;font-weight:bold">select</span> {
  <span style="color:#000;font-weight:bold">case</span> p.itemsCh <span style="color:#000;font-weight:bold">&lt;-</span> keys:
      p.stats.<span style="color:#900;font-weight:bold">Add</span>(keepGets, keys[<span style="color:#099">0</span>], <span style="color:#0086b3">uint64</span>(<span style="color:#0086b3">len</span>(keys)))
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span>
  <span style="color:#000;font-weight:bold">default</span>:
      p.stats.<span style="color:#900;font-weight:bold">Add</span>(dropGets, keys[<span style="color:#099">0</span>], <span style="color:#0086b3">uint64</span>(<span style="color:#0086b3">len</span>(keys)))
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
  }

p.itemCh processing:
  <span style="color:#000;font-weight:bold">func</span> (p <span style="color:#000;font-weight:bold">*</span>tinyLFU) <span style="color:#900;font-weight:bold">Push</span>(keys []<span style="color:#458;font-weight:bold">uint64</span>) {
    <span style="color:#000;font-weight:bold">for</span> _, key <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> keys {
      p.<span style="color:#900;font-weight:bold">Increment</span>(key)
    }
  }</code></pre></div>
<p>The performance benefits of using a <code>sync.Pool</code> over anything else (slices,
striped mutexes, etc.) are mostly due to the internal usage of thread-local
storage, <em>something not available as a public API to Go users.</em></p>
<h4 id="sets">Sets</h4>
<p>The requirements for Set buffer is slightly different from Get. In Gets,
we buffer up the keys, only processing them once the buffer fills up. In Sets,
we want to process the keys as soon as possible. <strong>So, we use a channel to
capture the Sets, dropping them on the floor if the channel is full to avoid
contention.</strong> A couple of background goroutines pick sets from the channel and
process the Set.</p>
<p>This approach, as with Gets, is designed to optimize for contention resistance.
But, comes with a few caveats, described below.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">select</span> {
<span style="color:#000;font-weight:bold">case</span> c.setBuf <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">&amp;</span>item{key: hash, val: val, cost: cost}:
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span>
<span style="color:#000;font-weight:bold">default</span>:
    <span style="color:#998;font-style:italic">// drop the set and avoid blocking
</span><span style="color:#998;font-style:italic"></span>    c.stats.<span style="color:#900;font-weight:bold">Add</span>(dropSets, hash, <span style="color:#099">1</span>)
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>
}</code></pre></div>
<h4 id="caveats">Caveats</h4>
<p>Sets in <a href="https://github.com/dgraph-io/ristretto">Ristretto</a> are queued into a buffer, control is returned back to the
caller, and the buffer is then applied to the cache. This has two side-effects:</p>
<ol>
<li><strong>There is no guarantee that a set would be applied.</strong> It could be dropped
immediately to avoid contention or could be rejected later by the policy.</li>
<li>Even if a Set gets applied, it might take a few milliseconds after the call
has returned to the user. In database terms, it is an <em>eventual consistency</em>
model.</li>
</ol>
<p>If however, a key is already present in the cache, Set would update the key
immediately. This is to avoid a cached key holding a stale value.</p>
<h4 id="contention-resistance">Contention Resistance</h4>
<p><strong>Ristretto is optimized for contention resistance.</strong> This performs really well
under heavy concurrent load, as we'll see with throughput benchmarks below. However, it
would lose some metadata in exchange for better throughput performance.</p>
<p>Interestingly, that information loss doesn't hurt our hit ratio performance because of
the nature of key access distributions. If we do lose metadata, it is generally
lost uniformly while the key access distribution remains non-uniform. Therefore,
we still achieve high hit ratios and the hit ratio degradation is small as shown
by the following graph.</p>
<p><img src="/images/rt-hit-degrade.svg?sanitize=true" alt="Ristretto Hit Ratio Degradation"></p>
<h3 id="memory-bounding">Memory Bounding</h3>
<h4 id="key-cost">Key Cost</h4>
<p><em>An infinitely large cache is practically impossible.</em> A cache must be bounded in
size. Many cache libraries would consider cache size to be the number of elements. We
found that approach <em>naive</em>. Surely it works in a workload where values are of
identical size. Most workloads, however, have variable-sized values. One value
could cost a few bytes, another a few kilobytes and yet another, a few
megabytes. Treating them as having the same memory cost isn't realistic.</p>
<p><strong>In <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>, we attach a cost to every key-value.</strong> Users can specify
what that cost is when calling Set. We count this cost against the MaxCost of
the cache. When the cache is operating at capacity, a <em>heavy</em> item could
displace many <em>lightweight</em> items.  This mechanism is nice in that it works well
for all different workloads, including the naive approach where each
key-value costs 1.</p>
<h4 id="admission-policy-via-tinylfu">Admission Policy via TinyLFU</h4>
<blockquote>
<p>&ldquo;What should we let into the cache?&rdquo;</p>
</blockquote>
<p>is answered by the admission policy. The goal, obviously, is to let
in new items if they are more <em>&ldquo;valuable&rdquo;</em> than the current items. However, this
becomes a challenge if you consider the overhead (latency and memory) required
to track relevant item information pertaining to the <em>&ldquo;value&rdquo;</em> question.</p>
<p>Despite being a well-documented strategy for increasing hit ratios, most Go
cache libraries have no admission policy at all. In fact, many LRU eviction
implementations assume the latest key as the most valuable.</p>
<p>Moreover, most of the Go cache libraries use pure LRU or an approximation of LRU as their
eviction policy. The quality of LRU approximation notwithstanding, some
workloads are just better suited to LFU eviction policies. We've found this to
be the case in our benchmarks using various traces.</p>
<p>For our admission policy, we looked at a new and fascinating paper called
<strong><a href="/refs/TinyLFU%20-%20A%20Highly%20Efficient%20Cache%20Admission%20Policy.pdf">TinyLFU</a>: A Highly Efficient Cache Admission Policy.</strong> At a very high
level, TinyLFU provides three methods:</p>
<ul>
<li>Increment(key uint64)</li>
<li>Estimate(key uint64) int (referred as )</li>
<li>Reset</li>
</ul>
<p>The <a href="/refs/TinyLFU%20-%20A%20Highly%20Efficient%20Cache%20Admission%20Policy.pdf">paper</a> explains it best, but TinyLFU is an eviction-agnostic
admission policy designed to improve hit ratios with very little memory
overhead. The main idea is to <strong>only let in a new item if its estimate is higher
than that of the item being evicted.</strong> We implemented TinyLFU in <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>
using a <a href="https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch">Count-Min</a> Sketch. It uses 4-bit counters to approximate the
frequency of access for the item (). This small cost per key allows us
to keep track of a much larger sample of the global keyspace, than would be
possible using a normal key to frequency map.</p>
<p>TinyLFU also maintains the recency of key access by a <code>Reset</code> function. After N key
increments, the counters get halved. So, a key that has not been seen for a
while would have its counter get reset to zero; paving the way for more
recently seen keys.</p>
<h4 id="eviction-policy-via-sampled-lfu">Eviction Policy via Sampled LFU</h4>
<p>When the cache reaches capacity, every incoming key should displace one or more
keys present in the cache. Not only that, <strong>the  of incoming key should be higher
than the  of key being evicted.</strong> To find a key with low , we used the natural
<a href="https://blog.golang.org/go-maps-in-action">randomness</a> provided by Go map iteration to pick a sample of keys and
loop over them to find a key with the lowest .</p>
<p>We then compare the  of this key against the incoming key. If the incoming key
has a higher , then this key gets evicted (<em>eviction policy</em>). Otherwise, the
incoming key is rejected (<em>admission policy</em>).  This mechanism is repeated until
the incoming key's cost can be fit into the cache. Thus, a single incoming key
may displace more than one key. <em>Note that the cost of the incoming key does not
play a factor in choosing the eviction keys.</em></p>
<p><strong>With this approach, the hit ratios are within 1% of the exact LFU policies for a
variety of workloads.</strong> This means we get the benefits of admission policy,
conservative memory usage, and lower contention in the same little package.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// Snippet from the Admission and Eviction Algorithm
</span><span style="color:#998;font-style:italic"></span>incHits <span style="color:#000;font-weight:bold">:=</span> p.admit.<span style="color:#900;font-weight:bold">Estimate</span>(key)
<span style="color:#000;font-weight:bold">for</span> ; room &lt; <span style="color:#099">0</span>; room = p.evict.<span style="color:#900;font-weight:bold">roomLeft</span>(cost) {
    sample = p.evict.<span style="color:#900;font-weight:bold">fillSample</span>(sample)
    minKey, minHits, minId <span style="color:#000;font-weight:bold">:=</span> <span style="color:#0086b3">uint64</span>(<span style="color:#099">0</span>), <span style="color:#0086b3">int64</span>(math.MaxInt64), <span style="color:#099">0</span>
    <span style="color:#000;font-weight:bold">for</span> i, pair <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> sample {
        <span style="color:#000;font-weight:bold">if</span> hits <span style="color:#000;font-weight:bold">:=</span> p.admit.<span style="color:#900;font-weight:bold">Estimate</span>(pair.key); hits &lt; minHits {
            minKey, minHits, minId = pair.key, hits, i
        }
    }
    <span style="color:#000;font-weight:bold">if</span> incHits &lt; minHits {
        p.stats.<span style="color:#900;font-weight:bold">Add</span>(rejectSets, key, <span style="color:#099">1</span>)
        <span style="color:#000;font-weight:bold">return</span> victims, <span style="color:#000;font-weight:bold">false</span>
    }
    p.evict.<span style="color:#900;font-weight:bold">del</span>(minKey)
    sample[minId] = sample[<span style="color:#0086b3">len</span>(sample)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>]
    sample = sample[:<span style="color:#0086b3">len</span>(sample)<span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>]
    victims = <span style="color:#0086b3">append</span>(victims, minKey)
}</code></pre></div>
<h4 id="doorkeeper">DoorKeeper</h4>
<p>Before we place a new key in TinyLFU, <a href="https://github.com/dgraph-io/ristretto">Ristretto</a> uses a bloom filter to first
check if the key has been seen before. Only if the key is already present in the
bloom filter, is it inserted into the TinyLFU. This is to avoid <em>polluting</em>
TinyLFU with a long tail of keys that are not seen more than once.</p>
<p>When calculating  of a key, if the item is included in the bloom filter, its
frequency is estimated to be the Estimate from TinyLFU plus one. During a
<code>Reset</code> of TinyLFU, the bloom filter is also cleared out.</p>
<h3 id="metrics">Metrics</h3>
<p>While optional, it is important to understand how a cache is behaving. We wanted
to ensure that tracking metrics related to cache is not only possible, the
overhead of doing so is low enough to be turned on and kept on.</p>
<p>Beyond hits and misses, Ristretto tracks metrics like keys and their cost being
added, updated and evicted, sets being dropped or rejected, and gets being
dropped or kept. All these numbers help understand the cache behavior on various
workloads and pave way for further optimizations.</p>
<p>We initially used atomic counters for these. However, the overhead was
significant. We narrowed the cause down to <a href="https://dzone.com/articles/false-sharing">False Sharing</a>. Consider a
multi-core system, where different atomic counters (8-bytes each) fall in the
same cache line (typically 64 bytes). Any update made to one of these counters,
causes the others to be marked <em>invalid</em>. This forces a cache reload for all
other cores holding that cache, thus creating a write contention on the cache
line.</p>
<p><strong>To achieve scalability, we ensure that each atomic counter completely occupies
a full cache line.</strong> So, every core is working on a different cache line.
Ristretto uses this by allocating 256 uint64s for each metric, leaving 9 unused
uint64s between each active uint64. To avoid extra computation, the key hash is
reused to determine which uint64 to increment.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">Add:
	valp <span style="color:#000;font-weight:bold">:=</span> p.all[t]
	<span style="color:#998;font-style:italic">// Avoid false sharing by padding at least 64 bytes of space between two
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#998;font-style:italic">// atomic counters which would be incremented.
</span><span style="color:#998;font-style:italic"></span>	idx <span style="color:#000;font-weight:bold">:=</span> (hash <span style="color:#000;font-weight:bold">%</span> <span style="color:#099">25</span>) <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">10</span>
	atomic.<span style="color:#900;font-weight:bold">AddUint64</span>(valp[idx], delta)

Read:
	valp <span style="color:#000;font-weight:bold">:=</span> p.all[t]
	<span style="color:#000;font-weight:bold">var</span> total <span style="color:#458;font-weight:bold">uint64</span>
	<span style="color:#000;font-weight:bold">for</span> i <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">range</span> valp {
		total <span style="color:#000;font-weight:bold">+=</span> atomic.<span style="color:#900;font-weight:bold">LoadUint64</span>(valp[i])
	}
	<span style="color:#000;font-weight:bold">return</span> total</code></pre></div>
<p>When reading the metric, all the uint64s are read and summed up to get the
latest number. <strong>With this approach, metrics tracking only adds around 10%
overhead to the cache performance.</strong></p>
<h3 id="benchmarks">Benchmarks</h3>
<p>Now that you understand the various mechanisms present in <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>, let's look
at the Hit ratio and Throughput benchmarks compared to other popular Go caches.</p>
<h4 id="hit-ratios">Hit Ratios</h4>
<p>Hit ratios were measured using Damian Gryski's <a href="https://github.com/dgryski/trifles/blob/master/cachetest/main.go">cachetest</a> along with our
own benchmarking <a href="https://github.com/dgraph-io/benchmarks/tree/master/cachebench">suite</a>. The hit ratio numbers are the same across
both utilities, but we added the ability to read certain trace formats (LIRS and
ARC, specifically) as well as CSV output for easier graphing. If you want to
write your own benchmarks or add a trace format, check out the
<a href="https://github.com/dgraph-io/ristretto/tree/master/sim">sim</a> package.</p>
<p>To get a better idea of the room for improvement, <strong>we added a theoretically
<a href="https://en.wikipedia.org/wiki/Page_replacement_algorithm#The_theoretically_optimal_page_replacement_algorithm">optimal</a> cache implementation, which uses future knowledge to evict items
with the least amount of hits over its entire lifetime.</strong> Note that this is a
clairvoyant LFU eviction policy, where other clairvoyant policies may use LRU.
Depending on the workload, LFU or LRU may be better suited, but we found
clairvoyant LFU useful for comparisons with <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>&lsquo;s Sampled LFU.</p>
<h5 id="search">Search</h5>
<p>This trace is described as &ldquo;disk read accesses initiated by a large commercial
search engine in response to various web search requests.&rdquo;</p>
<p><img src="/images/rt-hit-search.svg?sanitize=true" alt="Hit Ratios: Search"></p>
<h5 id="database">Database</h5>
<p>This trace is described as &ldquo;a database server running at a commercial site
running an ERP application on top of a commercial database.&rdquo;</p>
<p><img src="/images/rt-hit-db.svg?sanitize=true" alt="Hit Ratios: Commercial DB"></p>
<h5 id="looping">Looping</h5>
<p>This trace demonstrates a looping access pattern. We couldn't include
Fastcache, Freecache, or Bigcache implementations in this and the following
benchmark because they have minimum capacity requirements that would skew the
results. Some trace files are small and require small capacities for performance
measurements.</p>
<p><img src="/images/rt-hit-loop.svg?sanitize=true" alt="Hit Ratios: Loop"></p>
<h5 id="codasyl">CODASYL</h5>
<p>This trace is described as &ldquo;references to a CODASYL database for a one hour
period.&rdquo; Note that <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>&lsquo;s performance suffers in comparison to the others
here. This is because of the LFU eviction policy being a bad fit for this
workload.</p>
<p><img src="/images/rt-hit-codasyl.svg?sanitize=true" alt="Hit Ratios: CODASYL"></p>
<h4 id="throughput">Throughput</h4>
<p>Throughput was measured using the <a href="https://github.com/dgryski/trifles/blob/master/cachetest/main.go">same utility</a> as the <a href="https://blog.dgraph.io/post/caching-in-go/">previous</a> blog post,
which generates a large number of keys and alternates between goroutines for
Getting and Setting according to the workload.</p>
<p>All throughput benchmarks were ran on an Intel Core i7-8700K (3.7GHz) with 16gb
of RAM.</p>
<h5 id="mixed-25-writes-75-reads">Mixed: 25% Writes, 75% Reads</h5>
<p><img src="/images/rt-thr-mixed.svg?sanitize=true" alt="Mixed Workload"></p>
<h5 id="read-100-reads">Read: 100% Reads</h5>
<p><img src="/images/rt-thr-read.svg?sanitize=true" alt="Read Workload"></p>
<h5 id="write-100-writes">Write: 100% Writes</h5>
<p><img src="/images/rt-thr-write.svg?sanitize=true" alt="Write Workload"></p>
<h3 id="future-improvements">Future Improvements</h3>
<p>As you may have noticed in the CODASYL benchmarks, <a href="https://github.com/dgraph-io/ristretto">Ristretto</a>&lsquo;s performance
suffers in LRU-heavy workloads. However, for most workloads, our Sampled LFU
policy performs quite well. The question then becomes <strong>&ldquo;How can we get the best
of both worlds?&quot;</strong></p>
<p>In a <a href="/refs/Adaptive%20Software%20Cache%20Management.pdf">paper</a> called <em>Adaptive Software Cache Management</em>, this exact
question is explored.  The basic idea is placing an LRU &ldquo;window&rdquo; before the main
cache segment, and adaptively sizing that window using hill-climbing techniques
to maximize the hit ratio. Caffeine has already seen
<a href="https://github.com/ben-manes/caffeine/wiki/Efficiency#adaptivity">great</a>
results by doing
<a href="https://github.com/ben-manes/caffeine/wiki/Design#adaptivity">this</a>.  Something
we believe Ristretto can benefit from as well in the future.</p>
<h3 id="special-thanks">Special Thanks</h3>
<p>We would like to sincerely thank <a href="https://github.com/ben-manes">Ben Manes</a>. His
depth of knowledge and dedicated, selfless sharing has been a large factor in
any progress we've made and we are honored to have had many conversations with
him about all things caching. Ristretto would just not have been possible
without his guidance, support and <em><a href="https://en.wikipedia.org/wiki/High_availability#%22Nines%22">99.9%</a></em> availability on our internal
Slack channel.</p>
<p>We would also like to thank <a href="https://twitter.com/dgryski">Damian Gryski</a> for his help with
benchmarking Ristretto and writing a reference <a href="https://github.com/dgryski/go-tinylfu">TinyLFU</a> implementation.</p>
<h2 id="conclusion">Conclusion</h2>
<p>We set out with the goal of making a cache library competitive with Caffeine.
While not completely there, <strong>we did create something significantly
<a href="https://en.wikipedia.org/wiki/Ristretto">better</a></strong> than most others in the Go world at the moment by using some
new techniques that others can learn from.</p>
<p>Some initial experiments with using this cache in Dgraph are looking promising.
And we hope to integrate <a href="https://github.com/dgraph-io/ristretto">Ristretto</a> into both <a href="https://github.com/dgraph-io/dgraph">Dgraph</a> and
<a href="https://github.com/dgraph-io/badger">Badger</a> in the upcoming months. Do <a href="https://github.com/dgraph-io/ristretto">check it out</a> and perhaps use
Ristretto to speed up your workloads!</p>
<hr>
<div class="engage">
	<p>
		<strong>
			We are building a fast, transactional and distributed graph database.
			If you like what you read above,
			<a href="https://dgraph.io/careers">come join</a> the team!
		</strong>
	</p>
  <table>
    <thead>
    <tr>
    <th></th>
    <th></th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td><a href="https://docs.dgraph.io" target="_blank">Get started with Dgraph</a></td>
      <td><a href="https://docs.dgraph.io" target="_blank">https://docs.dgraph.io</a></td>
    </tr>
    <tr>
      <td><a href="https://github.com/dgraph-io/dgraph" target="_blank">Star us on GitHub</a></td>
      <td><a href="https://github.com/dgraph-io/dgraph" target="_blank">https://github.com/dgraph-io/dgraph</a></td>
    </tr>
    <tr>
      <td><a href="https://discuss.dgraph.io" target="_blank">Ask us questions</a></td>
      <td><a href="https://discuss.dgraph.io" target="_blank">https://discuss.dgraph.io</a></td>
    </tr>
    </tbody>
  </table>
	<strong>Fortune 500 companies are using Dgraph in production. If you need production support,
    <a href="mailto:manish@dgraph.io">talk to us.</a></strong>
</div>
<br/>

<script>
	$('a[href="https://github.com/dgraph-io/dgraph"]').click(function(e) {
		var $el = $(e.target);
		if ($el.text().toLowerCase().indexOf('star') >= 0) {
			var pos = $el.offset();
			keenClient && keenClient.recordEvent('star-click', {
				offsetTop: pos.top,
				offsetLeft: pos.left,
			})

			ga && ga('send', 'event', 'Blog', 'text-star-click', 'Non Widget GitHub Click', 1);
		}
	})
</script>

<p><em>Top Image: <a href="https://bluebottlecoffee.com/preparation-guides/espresso">Blue
Bottle</a> Coffee Espresso Preparation Guide.</em></p>
</div>
          <div class="article-tag-list">
            
            
                
                
                    <a href="https://blog.dgraph.io/tags/cache/">Cache</a>
                
            
                
                
                    <a href="https://blog.dgraph.io/tags/go/">Go</a>
                
            
                
                
                    <a href="https://blog.dgraph.io/tags/hacker-news/">Hacker News</a>
                
            
                
                
                    <a href="https://blog.dgraph.io/tags/reddit/">Reddit</a>
                
            
          </div>
          <div class="modal fade" id="runnable-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <a href="#" data-dismiss="modal" class="modal-close-btn">
    Close
  </a>

  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">

      </div>
    </div>
  </div>
</div>
        </div>
      </div>
    </div>

    <footer class="article-footer">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <div class="article-author">
  <figure class="article-author__figure">
    
	<img src="/images/people/karl.jpg" class="article-author__image">


  </figure>
  <div class="article-author__bio">
    <h4 class="article-author__name">Karl McGuire


      <span class="article-author__title">Author</span>
    </h4>
    
<nav class="social__nav article-author__social">
    <ul class="social__list social__list--inline">
        <li class="social__item social__item--inline">
            <a href="https://www.linkedin.com/in/karlmcguire/" class="social__link">
                <svg class="icon social__icon social__icon--linkedin">
                    <use xlink:href="#icon-linkedin" xmlns:xlink="https://www.w3.org/1999/xlink"></use>
                </svg>
            </a>
        </li>
    </ul>
</nav>
<p>
    Karl McGuire is a Performance Engineer at Dgraph and a CS student at UNC Charlotte. He's interested in Unix,
    Plan 9, Go, and the future of distributed computing. When he's not typing or reading, he's at the gym.
</p>



  </div>
</div>

            
	<div class="article-author">
	<figure class="article-author__figure">
		
	<img src="/images/people/manish.jpg" class="article-author__image">


	</figure>
	<div class="article-author__bio">
		<h4 class="article-author__name">Manish Rai Jain


			<span class="article-author__title">Editor</span>
		</h4>
		
<nav class="social__nav article-author__social">
    <ul class="social__list social__list--inline">
        <li class="social__item social__item--inline">
            <a href="https://twitter.com/manishrjain" class="social__link">
                <svg class="icon social__icon social__icon--twitter">
                    <use xlink:href="#icon-twitter" xmlns:xlink="https://www.w3.org/1999/xlink"></use>
                </svg>
            </a>
        </li>
    </ul>
</nav>
<p>Manish is the Chief decision maker at Dgraph. He got thrust into distributed systems right out of college, working on real time web indexing systems at Google. He then lead various projects to consolidate and serve Knowledge Graph right behind web search.</p>
<p>Implementing GTD and Zero Waste practices, Manish is into efficient and minimalist living. He loves cycling, swimming and ultra light travelling.</p>



	</div>
</div>

          </div>
          <div class="col-12">
            <div id='discourse-comments'></div>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <div class="page-footer__wrapper">
  <footer id="page-footer" class="page-footer">
    <div class="container">
      <div class="row">
        <div class="col-12 col-md-3">
          <figure class="page-logo-footer"><a href="/"><img src="/images/logo.svg" width="140" height="42" alt="Company Logo"></a></figure>
        </div>
        
        <div class="col-4 col-md-2">
          <nav class="page-footer-nav">
            <h6 class="page-footer-nav__title">Company</h6>
            <ul class="page-footer-nav__list">
              <li class="page-footer-nav__item"><a href="https://dgraph.io/about.html" title="Learn More about us" target="_blank" class="page-footer-nav__link">About</a></li>
              <li class="page-footer-nav__item"><a href="https://dgraph.io/careers.html" title="See open positions" target="_blank" class="page-footer-nav__link">Careers</a></li>
              <li class="page-footer-nav__item"><a href="https://dgraph.io/contact.html" title="How can you reach us" target="_blank" class="page-footer-nav__link">Contact</a></li>
              
              <li class="page-footer-nav__item"><a href="https://wiki.dgraph.io/Beginners_Guide#Installation" title="Download" target="_blank" class="page-footer-nav__link page-footer-nav__link--download">Download</a></li>
              
            </ul>
          </nav>
        </div>
        
        <div class="col-4 col-md-2">
          <nav class="page-footer-nav">
            <h6 class="page-footer-nav__title">Community</h6>
            <ul class="page-footer-nav__list">
              <li class="page-footer-nav__item"><a href="https://blog.dgraph.io/post/introducing-ristretto-high-perf-go-cache/" title="Our thoughts" target="_blank" class="page-footer-nav__link">Blog</a></li>
              
              <li class="page-footer-nav__item"><a href="https://wiki.dgraph.io/" title="Documentation" target="_blank" class="page-footer-nav__link">Documentation</a></li>
              
              
              <li class="page-footer-nav__item"><a href="https://github.com/dgraph-io/dgraph" title="We are on GitHub, check it out." target="_blank" class="page-footer-nav__link">GitHub</a></li>
              
              
              <li class="page-footer-nav__item"><a href="https://discuss.dgraph.io/" title="Join our community" target="_blank" class="page-footer-nav__link">Discuss</a></li>
              
              
              <li class="page-footer-nav__item"><a href="https://slack.dgraph.io/" title="Join our community" target="_blank" class="page-footer-nav__link">Slack</a></li>
              
            </ul>
          </nav>
        </div>
        <div class="col-4 col-md-2">
          <nav class="page-footer-nav">
            <h6 class="page-footer-nav__title">Connect</h6>
            <ul class="page-footer-nav__list">
              
              <li class="page-footer-nav__item"><a href="https://twitter.com/dgraphlabs" title="Follow us on twitter" target="_blank" class="page-footer-nav__link">Twitter</a></li>
              
              
              <li class="page-footer-nav__item"><a href="https://angel.co/dgraph-labs" title="Follow us on twitter" target="_blank" class="page-footer-nav__link">Angel List</a></li>
              
            </ul>
          </nav>
        </div>
      </div>
      <div class="row">
        <span class="imprint__copyrights">Copyright (c) 2017, Dgraph Labs, Inc. All rights reserved.</span>
      </div>
    </div>

    <div class="github-engage">
      <div class="line1">Do you like our blog?</div>
      <a class="github-close" href="javascript:void(0)">
        <i class="fa fas fa-times"></i>
      </a>

      <div id="star-us-wrapper">
        <a
            class="github-button"
            href="https://github.com/dgraph-io/dgraph"
            data-size="large" data-show-count="true"
            aria-label="Star dgraph-io/dgraph on GitHub">
          Star us on GitHub
        </a>
      </div>
      <div class="love">
        <div class="heart-wrapper">
          <div class="heart">
            <div class="tl"></div>
            <div class="tr"></div>
            <div class="bl"></div>
            <div class="br"></div>
          </div>
          <div class="ring"></div>
          <div class="circles"></div>
        </div>

        <div class="love-text">
          We Love You!
        </div>
      </div>
    </div>
  </footer>
  
</div>

    <script src="https://blog.dgraph.io//js/clipboard.min.js"></script>
    <script
      src='https://blog.dgraph.io//js/runnable.js?29f8ba4fb8d90804cf24ff53b70192ad'
    ></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>




<script>
  window.Countly = window.Countly || {};
  Countly.q = Countly.q || [];

  Countly.q.push(['track_sessions']);
  Countly.q.push(['track_pageview']);
  (function() {
  	var cly = document.createElement('script');
  	cly.type = 'text/javascript';
  	cly.async = true;
  	cly.src = "https://dgraph.io/assets/js/unminified/stats/dgraph-stats.min.js";
  	cly.onload = function() {
      Countly.init({
        app_key: "e93284ab5e5d21ef9eb16a94516b3c1c6eba1015",
        url: "https://stats.dgraph.io",
        force_post: true,
      })
  	};
  	document.body.appendChild(cly);
  })();
</script>


<script>
$(document.links)
  .filter(function() {
    return this.hostname != window.location.hostname;
  })
  .attr("target", "_blank");
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/visibility.js/1.2.4/visibility.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
<link
  href='https://blog.dgraph.io/css/heart.css?24a50879951b2391f04750723b4a012e'
  rel="stylesheet">
<link
  href='https://blog.dgraph.io/css/github-engage.css?d60d80bf2b6a24350cdb5d834ab47e27'
  rel="stylesheet">

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"
  integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps="
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src='/js/custom.js?94f0c667422b8dac293e14c9c49872e3'
></script>

<script src="//unpkg.com/@dgraph-io/community"></script>

</body>
</html>

  

  
  <script type="text/javascript">
DiscourseEmbed = {
  discourseUrl: "https:\/\/discuss.dgraph.io\/",
  discourseEmbedUrl: "https:\/\/blog.dgraph.io\/post\/introducing-ristretto-high-perf-go-cache\/"
};
(function() {
  var d = document.createElement("script");
  d.type = "text/javascript";
  d.async = true;
  d.src = DiscourseEmbed.discourseUrl + "javascripts/embed.js";
  (document.getElementsByTagName("head")[0] ||
    document.getElementsByTagName("body")[0])
    .appendChild(d);
})();
</script>
  <noscript>Please enable JavaScript to view the comments on <a href="https://discuss.dgraph.io/">discuss</a>.</noscript>
  
</html>
