<!DOCTYPE html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
  <link rel="canonical" href="https://blog.dgraph.io/post/rpc-vs-grpc/" />


  <link rel="apple-touch-icon" sizes="57x57" href="https://dgraph.io/assets/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://dgraph.io/assets/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://dgraph.io/assets/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://dgraph.io/assets/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://dgraph.io/assets/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://dgraph.io/assets/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://dgraph.io/assets/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://dgraph.io/assets/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://dgraph.io/assets/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"
    href="https://dgraph.io/assets/images/favicons/android-icon-192x192.png">
  <link rel="manifest" href="https://dgraph.io/assets/images/favicons/manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="https://dgraph.io/assets/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://dgraph.io/assets/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://dgraph.io/assets/images/faviconsfavicon-16x16.png">
  <link rel="shortcut icon" href="https://dgraph.io/assets/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="https://dgraph.io/assets/images/faviconsms-icon-144x144.png">
  <meta name="msapplication-config" content="https://dgraph.io/assets/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.dgraph.io//index.xml">
  
  <title>Custom encoding: Go implementation in net/rpc vs grpc and why we switched - Dgraph Blog</title>
  <meta property='og:title' content="Custom encoding: Go implementation in net/rpc vs grpc and why we switched - Dgraph Blog">
  <meta property="og:type" content="article">
  

  <meta property="og:url" content="https://blog.dgraph.io/post/rpc-vs-grpc/">
  
  
  <meta property="og:image" content="https://blog.dgraph.io//images/martian-encoding.jpg">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"
    integrity="sha256-0rguYS0qgS6L4qVzANq4kjxPLtvnp5nn2nB5G1lWRv4=" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/default.min.css" rel="stylesheet"
    integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"
    integrity="sha256-sNPiigbfSkqUzMc5rgrdztLnneCMAp6W9wetJUZu9Zw=" crossorigin="anonymous"></script>
  <link
    href='https://blog.dgraph.io//css/runnable.css?7bbf71b4888bc97241e85bc7326a12fe'
    rel="stylesheet" />
  
  <link
    href='https://blog.dgraph.io//css/runnable-custom.css?74110b504a7b8a6e92a95279cfa96032'
    rel="stylesheet" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500&display=swap" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

  <link href="https://dgraph.io/assets/css/style.min.css?06052020-1" rel="stylesheet" type="text/css" />

  <link href="https://dgraph.io/assets/css/font-awesome/css/all.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital@1&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">


  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.js"
    integrity="sha256-x3BtPVERvw1ozPlwivuFLZoViFCeAAs1Gt6SxEedmo8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.css"
    integrity="sha256-7sZe9dsqyNZC9Mk+WPRB7nVvPPPXyorzm2QKqlgXC4k=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/addon/edit/closebrackets.min.js"
    integrity="sha256-qhu2a7DSpQaammMaLw1iruxBpxmgdw8mdQaQWQUokcY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/javascript/javascript.min.js"
    integrity="sha256-7Bdg/UdDMmHDPafpQDYZNPCEbnRP7eAvu+2hEoqRCXs=" crossorigin="anonymous"></script>
  

  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@3/dist/algoliasearch.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.0.0/dist/instantsearch.production.min.js"
    integrity="sha256-6S7q0JJs/Kx4kb/fv0oMjS855QTz5Rc2hh9AkIUjUsk=" crossorigin="anonymous"></script>
  <script src="https://blog.dgraph.io//js/search.js?04292020"></script>
  <script>

    $(".subscribe-box").hide();
    $(window).scroll(function () {
      if ($(window).scrollTop() > 400) {
        $(".subscribe-box").fadeIn("fast");
      }
      else {
        $(".subscribe-box").fadeOut("fast");
      }
    });
   
    
    
    $(window).scroll(function () {
      if ($(window).scrollTop() > 180) {
        $("#page-header").addClass("bg-white");
      }
      else {
        $("#page-header").removeClass("bg-white");
      }
    });

    $(document).scroll(function () {
      checkOffset();
    });

   
    function checkOffset() {
      var x = $(".container").offset();
        var leftPosition = x.left + 75;
      if ($('.subscribe-box').offset().top + $('.subscribe-box').height()
        >= $('.bottom-section').offset().top - 10){
        $('.subscribe-box').addClass('footer-before');
        $('.footer-before').css('left',  -leftPosition  );
        }
      if ($(document).scrollTop() + window.innerHeight < $('.bottom-section').offset().top){
        $('.subscribe-box').removeClass('footer-before');
        $('.subscribe-box').css('left',  '30px' );
      }
         
    }
    $(document).ready(function () {
      $( ".page-search" ).wrapInner( "<div class='wrapper'></div>")
      $('.wrapper').after($('.page-search__results'))

      $(".subscribe-box-mobi .click-btn").click(function () {
        $(".subscribe-box").toggleClass("open");
        $(".subscribe-box-mobi").toggleClass('hide');
      });
      $(".subscribe-box .close").click(function () {
        $(".subscribe-box").toggleClass("open");
        $(".subscribe-box-mobi").toggleClass('hide');
      });
      $('.nav-icon').click(function() {
	    $('.page-nav').toggleClass('shownav');
	    $(this).toggleClass('active');
  });
  var $nav = document.querySelector('.page-nav > ul');
	var $navItems = document.querySelectorAll('.page-nav > ul > li');
	var $navItemHeading = document.querySelectorAll('.page-nav > ul > li > div');
  var $subnav = document.querySelectorAll('.page-nav > ul > li > ul');
  $($navItemHeading).click(function(e) {
	    $($navItems).removeClass('active');
	    $(this).parent().toggleClass('active');
	});
  $('.nav-icon[target="_blank"]').removeAttr('target');
  
    });
  </script>

  
  
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://blog.dgraph.io//images/martian-encoding.jpg" />
  
  

  <meta name="twitter:title" content="Custom encoding: Go implementation in net/rpc vs grpc and why we switched" />
  <meta name="twitter:description"
    content="At Dgraph
, we aim to build a low latency, distributed graph database.
This means our data is distributed among nodes in the cluster.
Executing a query means multiple nodes are communicating with each other.
To keep our latency of communication low, we use a new form of serialization library called Flatbuffers." />
  
  <meta name="twitter:site" content="@dgraphlabs" />

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-666192333"></script>
  <script>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'AW-666192333');</script>
</head>
<body class="blog-single has-lightning" data-gr-c-s-loaded="true">
   <header id="page-header" class="page-header">
	<div class="page-logo">
		<a href="https://dgraph.io/">
			<img src="https://dgraph.io/assets/images/logo.svg">
		</a>
		<a href="javascript:;" class="nav-icon" >
			<div class="hamburger">
				<div class="line line-1"></div>
				<div class="line line-2"></div>
				<div class="line line-3"></div>
			</div>
		</a>
	</div>
	<nav class="page-nav">
    <ul>
        <li>
            <div data-label="Products">
                <span>Products</span>
            </div>
            <ul>
                <li>
                    <a href="https://dgraph.io/graphql" data-label="GraphQL">
                        <span>GraphQL</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/enterprise" data-label="Enterprise">
                        <span>Enterprise</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/downloads" data-label="Downloads">
                        <span>Downloads</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/badger" data-label="Badger">
                        <span>Badger</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/compare-features" data-label="Compare Features">
                        <span>Compare Features</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Learn" class="is-active">
                <span>Learn</span>
            </div>
            <ul>
                <li>
                    <a href="https://dgraph.io/blog" data-label="Blog">
                        <span>Blog</span>
                    </a>
                </li>
                <li>
                    <a href="https://tour.dgraph.io" target="_blank" data-label="Interactive Tour">
                        <span>Interactive Tour</span>
                    </a>
                </li>
                <li>
                    <a href="https://discuss.dgraph.io" target="_blank" data-label="Forum">
                        <span>Forum</span>
                    </a>
                </li>
                <li>
                    <a href="https://slack.dgraph.io" target="_blank" data-label="Slack">
                        <span>Slack</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/paper" target="_blank" data-label="Paper">
                        <span>Paper</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Docs"><span>Docs</span></div>
            <ul>
                <li>
                    <a href="https://docs.dgraph.io" target="_blank" data-label="Dgraph Docs">
                        <span>Dgraph Docs</span>
                    </a>
                </li>
                <li>
                    <a href="https://graphql.dgraph.io/docs/" target="_blank" data-label="GraphQL Docs">
                        <span>GraphQL Docs</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Company"><span>Company</span></div>
            <ul>
                <li>
                    <a href="https://dgraph.io/about" data-label="Team">
                        <span>Team</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/careers" data-label="Careers">
                        <span>Careers</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/contact" data-label="Contact">
                        <span>Contact</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/conduct" data-label="Conduct">
                        <span>Conduct</span>
                    </a>
                </li>
            </ul>
        </li>
    </ul>
</nav>

	<div class="page-cta">
    <ul>
        <li class="hide-tablet">
            <a href="https://dgraph.io/contact" title="Contact">Contact</a>
        </li>
        <li>
            <a href="https://dgraph.io/downloads" title="Download" class="button button--secondary">
                <span>Download</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </li>
    </ul>
</div>

</header>


   <section class="page-body">
      <div class="page-body__content">
         <div class="container">
            <div class="row justify-content-center">
               <div class="col-10 ">
                  <div class="page-search form-group has-search">
	<span class="fas fa-search form-control-feedback"></span>
	
</div>
               </div>
            </div>
         </div>
      </div>
      <div class="container">
         <div class="row justify-content-center">
            <div class="col-10 ">
               <div class="">
                  <div class="post__meta">
                     <div class="post__date">

    
        Sat, Jun 25, 2016
    
    
</div>

                     <div class="post__share">
                        
                        <a href="https://twitter.com/share?text=Custom%20encoding%3a%20Go%20implementation%20in%20net%2frpc%20vs%20grpc%20and%20why%20we%20switched&amp;url=https%3a%2f%2fblog.dgraph.io%2fpost%2frpc-vs-grpc%2f&amp;via=dgraphlabs"
                           target="_blank">
                        <i class="fab fa-twitter"></i>
                        </a>
                        
                     </div>
                  </div>
                  <div class="post__cover">
                     <img
                        src="https://blog.dgraph.io//images/martian-encoding.jpg">
                     <div class="post__header">
                        <h1 class="post__title">
                           Custom encoding: Go implementation in net/rpc vs grpc and why we switched
                        </h1>
                        
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>
        
    

</div>


                     </div>
                  </div>
                  <div
                     class="post__content inner-content lg-pl-80 lg-pr-80 md-pl-50 md-pr-50 xs-pl-30 xs-pr-30 clearfix">
                     <p>At <a href="https://github.com/dgraph-io/dgraph" target="_blank">Dgraph</a>
, we aim to build a low latency, distributed graph database.
This means our data is distributed among nodes in the cluster.
Executing a query means multiple nodes are communicating with each other.
To keep our latency of communication low, we use a new form of serialization library called <a href="https://google.github.io/flatbuffers/">Flatbuffers</a>.</p>

<blockquote>
<p>What sets FlatBuffers apart is that it represents hierarchical data in a flat binary buffer in such a way that it can still be accessed directly without parsing/unpacking, while also still supporting data structure evolution (forwards/backwards compatibility).
The only memory needed to access your data is that of the buffer.</p>
</blockquote>

<p><strong>How is Flatbuffers better than <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a></strong>? FlatBuffers does not need a parsing/unpacking step to a secondary representation before you can access data, often coupled with per-object memory allocation.</p>

<p><a href="https://github.com/dgraph-io/dgraph" target="_blank">Dgraph</a>
 responses can contain millions of entities and binary blob values.
And the fact that Flatbuffers doesn&rsquo;t need to recreate the entire information in language specific data structures is very helpful for both memory and speed.</p>

<p>Also, TCP is always going to be faster than HTTP, because HTTP is one extra layer on top of TCP.
So, our goal was to implement communication using RPC over custom encoding utilizing Flatbuffers.</p>

<h1 id="go-net-rpc">Go net/rpc</h1>

<p>Our first approach was to use Go language library <code>net/rpc</code> and implement custom encoding in it.</p>

<p>Helper function to deal with writing and parsing header for the payload:</p>

<pre><code>/*
 * Copyright 2016 DGraph Labs, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package conn

import (
    &quot;bytes&quot;
    &quot;encoding/binary&quot;
    &quot;fmt&quot;
    &quot;io&quot;

    &quot;github.com/dgraph-io/dgraph/x&quot;
)

type Query struct {
    Data []byte
}

type Reply struct {
    Data []byte
}

func writeHeader(rwc io.ReadWriteCloser, seq uint64,
    method string, data []byte) error {

    var bh bytes.Buffer
    var rerr error

    // In package x: func SetError(prev *error, n error)
    x.SetError(&amp;rerr, binary.Write(&amp;bh, binary.LittleEndian, seq))
    x.SetError(&amp;rerr, binary.Write(&amp;bh, binary.LittleEndian, int32(len(method))))
    x.SetError(&amp;rerr, binary.Write(&amp;bh, binary.LittleEndian, int32(len(data))))
    _, err := bh.Write([]byte(method))
    x.SetError(&amp;rerr, err)
    if rerr != nil {
        return rerr
    }
    _, err = rwc.Write(bh.Bytes())
    return err
}

func parseHeader(rwc io.ReadWriteCloser, seq *uint64,
    method *string, plen *int32) error {

    var err error
    var sz int32
    x.SetError(&amp;err, binary.Read(rwc, binary.LittleEndian, seq))
    x.SetError(&amp;err, binary.Read(rwc, binary.LittleEndian, &amp;sz))
    x.SetError(&amp;err, binary.Read(rwc, binary.LittleEndian, plen))
    if err != nil {
        return err
    }

    buf := make([]byte, sz)
    n, err := rwc.Read(buf)
    if err != nil {
        return err
    }
    if n != int(sz) {
        return fmt.Errorf(&quot;Expected: %v. Got: %v\n&quot;, sz, n)
    }
    *method = string(buf)
    return nil
}
</code></pre>

<p>Code at server to read requests and write responses:</p>

<pre><code>/*
 * Copyright 2016 DGraph Labs, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package conn

import (
    &quot;io&quot;
    &quot;log&quot;
    &quot;net/rpc&quot;
)

type ServerCodec struct {
    Rwc        io.ReadWriteCloser
    payloadLen int32
}

func (c *ServerCodec) ReadRequestHeader(r *rpc.Request) error {
    return parseHeader(c.Rwc, &amp;r.Seq, &amp;r.ServiceMethod, &amp;c.payloadLen)
}

func (c *ServerCodec) ReadRequestBody(data interface{}) error {
    b := make([]byte, c.payloadLen)
    _, err := io.ReadFull(c.Rwc, b)
    if err != nil {
        return err
    }

    if data == nil {
        // If data is nil, discard this request.
        return nil
    }
    query := data.(*Query)
    query.Data = b
    return nil
}

func (c *ServerCodec) WriteResponse(resp *rpc.Response,
    data interface{}) error {

    if len(resp.Error) &gt; 0 {
        log.Fatal(&quot;Response has error: &quot; + resp.Error)
    }
    if data == nil {
        log.Fatal(&quot;Worker write response data is nil&quot;)
    }
    reply, ok := data.(*Reply)
    if !ok {
        log.Fatal(&quot;Unable to convert to reply&quot;)
    }

    if err := writeHeader(c.Rwc, resp.Seq,
        resp.ServiceMethod, reply.Data); err != nil {
        return err
    }

    _, err := c.Rwc.Write(reply.Data)
    return err
}

func (c *ServerCodec) Close() error {
    return c.Rwc.Close()
}
</code></pre>

<p>Similarly, the code at the client to read requests and write responses:</p>

<pre><code>/*
 * Copyright 2016 DGraph Labs, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package conn

import (
    &quot;errors&quot;
    &quot;fmt&quot;
    &quot;io&quot;
    &quot;log&quot;
    &quot;net/rpc&quot;
)

type ClientCodec struct {
    Rwc        io.ReadWriteCloser
    payloadLen int32
}

func (c *ClientCodec) WriteRequest(r *rpc.Request, body interface{}) error {
    if body == nil {
        return fmt.Errorf(&quot;Nil request body from client.&quot;)
    }

    query := body.(*Query)
    if err := writeHeader(c.Rwc, r.Seq, r.ServiceMethod, query.Data); err != nil {
        return err
    }
    n, err := c.Rwc.Write(query.Data)
    if n != len(query.Data) {
        return errors.New(&quot;Unable to write payload.&quot;)
    }
    return err
}

func (c *ClientCodec) ReadResponseHeader(r *rpc.Response) error {
    if len(r.Error) &gt; 0 {
        log.Fatal(&quot;client got response error: &quot; + r.Error)
    }
    if err := parseHeader(c.Rwc, &amp;r.Seq,
        &amp;r.ServiceMethod, &amp;c.payloadLen); err != nil {
        return err
    }
    return nil
}

func (c *ClientCodec) ReadResponseBody(body interface{}) error {
    buf := make([]byte, c.payloadLen)
    _, err := io.ReadFull(c.Rwc, buf)
    reply := body.(*Reply)
    reply.Data = buf
    return err
}

func (c *ClientCodec) Close() error {
    return c.Rwc.Close()
}
</code></pre>

<p>Also, each server should be able to send multiple requests in parallel.
So, we built a connection pool to create, store and reuse multiple connections:</p>

<pre><code>/*
 * Copyright 2016 DGraph Labs, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package conn

import (
    &quot;net&quot;
    &quot;net/rpc&quot;
    &quot;strings&quot;
    &quot;time&quot;

    &quot;github.com/dgraph-io/dgraph/x&quot;
)

var glog = x.Log(&quot;conn&quot;) // In package x: func Log(p string) *logrus.Entry

type Pool struct {
    clients chan *rpc.Client
    Addr    string
}

func NewPool(addr string, maxCap int) *Pool {
    p := new(Pool)
    p.Addr = addr
    p.clients = make(chan *rpc.Client, maxCap)
    client, err := p.dialNew()
    if err != nil {
        glog.Fatal(err)
        return nil
    }
    p.clients &lt;- client
    return p
}

func (p *Pool) dialNew() (*rpc.Client, error) {
    d := &amp;net.Dialer{
        Timeout: 3 * time.Minute,
    }
    var nconn net.Conn
    var err error
    // This loop will retry for 10 minutes before giving up.
    for i := 0; i &lt; 60; i++ {
        nconn, err = d.Dial(&quot;tcp&quot;, p.Addr)
        if err == nil {
            break
        }
        if !strings.Contains(err.Error(), &quot;refused&quot;) {
            break
        }

        glog.WithField(&quot;error&quot;, err).WithField(&quot;addr&quot;, p.Addr).
            Info(&quot;Retrying connection...&quot;)
        time.Sleep(10 * time.Second)
    }
    if err != nil {
        return nil, err
    }
    cc := &amp;ClientCodec{
        Rwc: nconn,
    }
    return rpc.NewClientWithCodec(cc), nil
}

func (p *Pool) Call(serviceMethod string, args interface{},
    reply interface{}) error {

    client, err := p.get()
    if err != nil {
        return err
    }
    if err = client.Call(serviceMethod, args, reply); err != nil {
        return err
    }

    select {
    case p.clients &lt;- client:
        return nil
    default:
        return client.Close()
    }
}

func (p *Pool) get() (*rpc.Client, error) {
    select {
    case client := &lt;-p.clients:
        return client, nil
    default:
        return p.dialNew()
    }
}

func (p *Pool) Close() error {
    // We're not doing a clean exit here. A clean exit here would require
    // synchronization, which seems unnecessary for now. But, we should
    // add one if required later.
    return nil
}
</code></pre>

<p>This worked well.
And both v0.2 and v0.3 of <a href="https://github.com/dgraph-io/dgraph" target="_blank">Dgraph</a>
 were using this code for the nodes to communicate with each other.</p>

<hr />

<h1 id="the-switch">The Switch</h1>

<p><img src="https://blog.dgraph.io/images/martian-receiving.jpg" alt="" /></p>

<p>At <a href="https://github.com/dgraph-io/dgraph" target="_blank">Dgraph</a>
, we spend Fridays learning and improving.
This means reading books, papers, articles, watching talks.
And we came across a great talk by Jeff Dean of Google: <a href="https://discuss.dgraph.io/t/jeff-deans-talk-about-rapid-response-times/83">Rapid Response Times</a></p>

<p>As I mentioned above, we care a lot about query latency.
After watching it a couple of times from two different conferences, the prime learning I gathered from his talk was:</p>

<ul>
<li>Send request to the first replica, telling it that it&rsquo;s going to send it to a second one.</li>
<li>2 ms later, send the request to the second one, telling it that it&rsquo;s already sent to the first one.</li>
<li>When one of them starts processing the request, it sends a cancellation request directly to its peer.</li>
<li>If the peer hasn&rsquo;t started processing the request, it would just cancel the request.</li>
<li>In a rare case, both of them process it and overall do twice the work.</li>
<li>Overall, your latencies improve considerably due to this method.</li>
</ul>

<p><a href="https://en.wikipedia.org/wiki/Jeff_Dean_(computer_scientist)">Jeff Dean</a> has an impressive track record at Google. He&rsquo;s behind almost every distributed system in production at Google.
So, when he gives a suggestion, you take it seriously.</p>

<p>At v0.4, we&rsquo;re not doing replication yet. So, we can&rsquo;t send queries to multiple servers in parallel.
However, that&rsquo;s how the system is going to look like a few minor releases down the lane.</p>

<p>So, we started thinking about how we could change our custom encoding based RPC implementation to achieve something like this.
Around the same time, we were looking for a way to figure out slow rpcs on servers.
<a href="https://forum.golangbridge.org/t/equivalent-of-rpcz-at-google/2609">Dave Cheney&rsquo;s response</a> pointed us to <a href="http://www.grpc.io/">grpc.io</a>.</p>

<p>While I had considered Google built <code>grpc</code> in the past, I&rsquo;d rejected it understanding that it requires you to use Protocol Buffers; but we&rsquo;d already chosen to go with Flatbuffers.
But when <a href="https://www.youtube.com/watch?v=sZx3oZt7LVg">Sameer Ajmani&rsquo;s talk</a> pointed that <code>grpc</code> is essentially a rewrite of Google internal Stubby from ground up, that got me to dig deeper.
<code>grpc</code> came with <code>net/context</code> which could easily do what Jeff Dean had talked about.
Also, it can help see live rpcs and track the slowest ones.</p>

<p>Overall, there was a lot of advantages to switching to <code>grpc</code>.
But, we didn&rsquo;t want to give up the performance benefits of Flatbuffers.</p>

<p>So, digging deeper, we found that <code>grpc</code> did support custom encoding. And we implemented it.
This is the whole equivalent code implemented in <code>grpc</code>:</p>

<pre><code>/*
 * Copyright 2016 DGraph Labs, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package worker

import (
    &quot;log&quot;

    &quot;google.golang.org/grpc&quot;
)

type PayloadCodec struct{}

func (cb *PayloadCodec) Marshal(v interface{}) ([]byte, error) {
    p, ok := v.(*Payload)
    if !ok {
        log.Fatalf(&quot;Invalid type of struct: %+v&quot;, v)
    }
    return p.Data, nil
}

func (cb *PayloadCodec) Unmarshal(data []byte, v interface{}) error {
    p, ok := v.(*Payload)
    if !ok {
        log.Fatalf(&quot;Invalid type of struct: %+v&quot;, v)
    }
    p.Data = data
    return nil
}

func (cb *PayloadCodec) String() string {
    return &quot;worker.PayloadCodec&quot;
}

type Pool struct {
    conns chan *grpc.ClientConn
    Addr  string
}

func NewPool(addr string, maxCap int) *Pool {
    p := new(Pool)
    p.Addr = addr
    p.conns = make(chan *grpc.ClientConn, maxCap)
    conn, err := p.dialNew()
    if err != nil {
        glog.Fatal(err)
        return nil
    }
    p.conns &lt;- conn
    return p
}

func (p *Pool) dialNew() (*grpc.ClientConn, error) {
    return grpc.Dial(p.Addr, grpc.WithInsecure(), grpc.WithInsecure(),
        grpc.WithCodec(&amp;PayloadCodec{}))
}

func (p *Pool) Get() (*grpc.ClientConn, error) {
    select {
    case conn := &lt;-p.conns:
        return conn, nil
    default:
        return p.dialNew()
    }
}

func (p *Pool) Put(conn *grpc.ClientConn) error {
    select {
    case p.conns &lt;- conn:
        return nil
    default:
        return conn.Close()
    }
}
</code></pre>

<p>And this is the proto file with Payload and <code>service</code>:</p>

<pre><code>syntax = &quot;proto3&quot;;

package worker;

message Payload {
    bytes Data = 1;
}

service Worker {
    rpc Hello (Payload) returns (Payload) {}
    rpc GetOrAssign (Payload) returns (Payload) {}
    rpc Mutate (Payload) returns (Payload) {}
    rpc ServeTask (Payload) returns (Payload) {}
}
</code></pre>

<hr />

<h1 id="conclusion">Conclusion</h1>

<p>So, turns out, <code>grpc</code> not only does custom encoding, but it also leads to</p>

<ul>
<li>smaller code footprint.</li>
<li><a href="https://godoc.org/golang.org/x/net/context">net/context</a>, which in turn allows client to cancel pending rpc requests to servers, among many other benefits.</li>
<li><a href="https://godoc.org/golang.org/x/net/trace">net/trace</a>, which allows tracing of rpcs and long-lived objects.</li>
</ul>

<p>For more, read the <a href="https://github.com/dgraph-io/dgraph/commit/c4629b907702748694712637cbef1fb2c1f15d07">pull request which made this change</a> across our code base.
Hope you find this useful.</p>

<p>Also read:</p>

<ul>
<li>Research paper on <a href="https://www.google.com.au/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwipuJ3rjsPNAhWEopQKHeeZBkMQFggiMAE&amp;url=http%3A%2F%2Fresearch.google.com%2Fpeople%2Fjeff%2FBerkeley-Latency-Mar2012.pdf&amp;usg=AFQjCNGnP9v7v9xN93MM6KPVJ7FcML6LvQ&amp;bvm=bv.125596728,d.dGo">Rapid Response Times</a> by Jeff Dean.</li>
<li>Blog post on <a href="https://blog.golang.org/context">Go Concurrency Patterns: Context</a> by Sameer Ajmani.</li>
<li>Slides on <a href="https://talks.golang.org/2014/gotham-context.slide#1">Cancellation, Context and Plumbing</a> by Sameer Ajmani.</li>
</ul>



<aside class="post__references">

    <h4>References</h4><p>Images courtesy: <a href="http://www.foxmovies.com/movies/the-martian">The Martian</a></p>
</aside>
                     
    <aside class="post__authors">
                <div class="tile author-tile">

    <img src="https://blog.dgraph.io/images/people/manish.jpg" class="author-tile__photo">

    <h4 class="author-tile__title">
        <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>,
        Author
    </h4>

    <p>Manish is the Chief decision maker at Dgraph. He got thrust into distributed
systems right out of college, working on real time web indexing systems at
Google. He then lead various projects to consolidate and serve Knowledge Graph
right behind web search.</p>

<p>Implementing GTD and Zero Waste practices, Manish is into efficient and
minimalist living. He loves cycling, swimming and ultra light travelling.</p>


    
        <nav class="author-tile__social">

            

            
                <a href="https://twitter.com/manishrjain" target="_blank">
                    <i class="fab fa-twitter"></i>
                </a>
            

            
                <a href="https://github.com/manishrjain" target="_blank">
                    <i class="fab fa-github"></i>
                </a>
            

        </nav>
    

</div>

            
        

    </aside>


                     <div class="  text-center subscribe-box">
    

    <h3>Get blog post to <br/>your inbox</h3>
    

<div id="mc_embed_signup">
<form action="https://dgraph.us17.list-manage.com/subscribe/post?u=f6c6a28bb40d10e26b88fff1c&amp;id=e85c448cac" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	
<div class="mc-field-group">
	
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="your Email">
</div>
	<div id="mce-responses" class="clear">
		<div class="response" id="mce-error-response" style="display:none"></div>
		<div class="response" id="mce-success-response" style="display:none"></div>
	</div>    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f6c6a28bb40d10e26b88fff1c_e85c448cac" tabindex="-1" value=""></div>
    <div class="clear"><button type="submit"  name="subscribe" id="mc-embedded-subscribe" class="button button--secondary mt-2"><span>Subscribe</span><i class="fas fa-arrow-right"></i></button></div>
    </div>
</form>
</div>
<script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<div class="d-flex align-items-center justify-content-center mt-4">
    <a href="https://github.com/dgraph-io/dgraph" target="_blank" ><i class="fa fa-github px-3"></i></a>
    <a href="https://slack.dgraph.io/" target="_blank"  ><i class="fa fa-slack px-3"></i></a>
    <a href="https://discuss.dgraph.io/" target="_blank"  ><i class="fa fa-comments px-3"></i></a>
</div>
<div class="close position-absolute d-block d-lg-none"><i class="fa fa-close"></i></div>

</div>

<div class="subscribe-box-mobi">
    <div class="d-flex align-items-center justify-content-center  flex-column">
        <a href="https://github.com/dgraph-io/dgraph" target="_blank" ><i class="fa fa-github py-3"></i></a>
        <a href="https://slack.dgraph.io/" target="_blank"  ><i class="fa fa-slack py-3"></i></a>
        <a href="https://discuss.dgraph.io/" target="_blank"  ><i class="fa fa-comments py-3"></i></a>
        <div class="click-btn"><i class="fa fa-envelope-o py-3"></i></div>

    </div>

</div>

                  </div>
               </div>
            </div>
         </div>
      </div>
      </div>
   </section>
   <div class='bottom-section'>
      <div class="container">
         <div class="post__content inner-content lg-pl-80 lg-pr-80 md-pl-50 md-pr-50 xs-pl-30 xs-pr-30 clearfix">
            <div class="post__comments">

    <div id="discourse-comments"></div>

    
    <script type="text/javascript">
        DiscourseEmbed = {
            discourseUrl: "https:\/\/discuss.dgraph.io\/",
            topicId:  1695 
            };
        (function() {
            var d = document.createElement("script");
            d.type = "text/javascript";
            d.async = true;
            d.src = DiscourseEmbed.discourseUrl + "javascripts/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(d);
        })();
    </script>
    <noscript>Please enable JavaScript to view the comments on <a href="https://discuss.dgraph.io/">discuss</a>.</noscript>
    

</div>

            <div class="modal fade" id="runnable-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <a href="#" data-dismiss="modal" class="modal-close-btn">
    Close
  </a>

  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">

      </div>
    </div>
  </div>
</div>
        </div>
        <div class="mx-auto" style="max-width:860px">

         <div
            class=" bg-gray xs-pt-60 xs-pb-60 round text-center md-pl-80 md-pr-80 own-success-story xs-mb-80  xs-mt-80 lg-ml-80 lg-mr-80 md-ml-50 md-mr-50 xs-ml-30 xs-mr-30 " >
            <p>Create you own success story.</p>
            <h2 class="font-medium">Interpret, store, distribute and execute GraphQL with the best.</h2>
            <div class="xs-mt-50 d-flex align-items-center justify-content-center flex-column flex-md-row">
               <a href="https://dgraph.io/downloads" class="button button--primary mr-0 mr-md-3"><span>Get
               Started</span> <i class="fas fa-arrow-right"></i></a>
               <a class="button  button--outline" target="_blank"
                  href="https://github.com/dgraph-io/dgraph"><span>View<span> on Github</span></span><i
                  class="fas fa-arrow-right"></i></a>
            </div>
        </div>

         </div>
         <div class="page-body__related-content mb-4">
            




<h3 class=" font-22 pb-4">But wait, thereâ€™s more...</h3>

<div class=" row justify-content-center mt-4">


    
    <div class="post col-sm-4">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/spacex-nasa-may2020.jpg">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Thu, Jun 4, 2020
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/solving-jepsen-with-opencensus/">How I solved Jepsen with OpenCensus Distributed Tracing: A personal journey</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>
        
    

</div>



    	</div>

    </div>
    
    <div class="post col-sm-4">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/dgraph-graphql-sticker.jpg">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Tue, Oct 29, 2019
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/building-native-graphql-database-dgraph/">Building a Native GraphQL Database: Challenges, Learnings and Future</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>
        
    

</div>



    	</div>

    </div>
    
    <div class="post col-sm-4">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/moonshot.jpg">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Wed, Jul 31, 2019
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/how-dgraph-labs-raised-series-a/">How Dgraph Labs Raised Series A</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>
        
    

</div>



    	</div>

    </div>
    

</div>



            

         </div>
      </div>
      <footer class="page-footer">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-5 col-sm-4">
        <div class="row">
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Products</h3>
            <ul>
              <li><a href="https://dgraph.io/graphql">GraphQL</a></li>
              <li><a href="https://dgraph.io/enterprise">Enterprise</a></li>
              <li><a href="https://dgraph.io/downloads">Downloads</a></li>
            </ul>
          </div>
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Learn</h3>
            <ul>
              <li><a href="https://dgraph.io/blog" target="_blank">Blog</a></li>
              <li><a href="https://tour.dgraph.io" target="_blank">Interactive Tour</a></li>
              <li><a href="https://discuss.dgraph.io" target="_blank">Forum</a></li>
              <li><a href="https://slack.dgraph.io" target="_blank">Slack</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-5 col-sm-4">
        <div class="row">
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Docs</h3>
            <ul>
              <li><a href="https://docs.dgraph.io" target="_blank">Dgraph Docs</a></li>
              <li><a href="https://graphql.dgraph.io/docs/" target="_blank">GraphQL Docs</a></li>
            </ul>
          </div>
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Company</h3>
            <ul>
              <li><a href="https://dgraph.io/about">Team</a></li>
              <li><a href="https://dgraph.io/careers">Careers</a></li>
              <li><a href="https://dgraph.io/contact">Contact</a></li>
              <li><a href="https://dgraph.io/conduct">Conduct</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3 offset-lg-1 border-above-sm">
        <div class="page-footer__cta"><a href="https://dgraph.io/downloads" title="Download" class="button button--secondary"><span>Download</span><i class="fas fa-arrow-right"></i></a></div>
        <div class="page-footer__address">
          <p>
            655 Montgomery Street, 7th Floor<br>
            San Francisco, CA 94111
          </p>
          <hr>
          <p><a href="mailto:contact@dgraph.io">contact@dgraph.io</a></p>
        </div>
      </div>
    </div>
    <div class="page-footer__social">
      <ul>
        <li><a href="https://twitter.com/dgraphlabs" target="_blank"><i class="fab fa-twitter"></i></a></li>
        <li><a href="https://github.com/dgraph-io/dgraph" target="_blank"><i class="fab fa-github"></i></a></li>
        <li><a href="https://www.youtube.com/channel/UCghE41LR8nkKFlR3IFTRO4w" target="_blank"><i class="fab fa-youtube"></i></a></li>
        <li><a href="https://slack.dgraph.io" target="_blank"><i class="fab fa-slack"></i></a></li>
        <li><a href="https://www.linkedin.com/company/dgraph-labs" target="_blank"><i class="fab fa-linkedin"></i></a></li>
      </ul>
    </div>
    <div class="page-footer__copyright">
      <p>
        <Copyright>&copy; 2017-2020 Dgraph Labs, Inc.</Copyright>
      </p>
    </div>
  </div>
</footer>

    <script src="https://blog.dgraph.io//js/clipboard.min.js"></script>
    <script
      src='https://blog.dgraph.io//js/runnable.js?29f8ba4fb8d90804cf24ff53b70192ad'
    ></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>




<script>
  window.Countly = window.Countly || {};
  Countly.q = Countly.q || [];

  Countly.q.push(['track_sessions']);
  Countly.q.push(['track_pageview']);
  (function() {
  	var cly = document.createElement('script');
  	cly.type = 'text/javascript';
  	cly.async = true;
  	cly.src = "https://dgraph.io/assets/js/unminified/stats/dgraph-stats.min.js";
  	cly.onload = function() {
      Countly.init({
        app_key: "e93284ab5e5d21ef9eb16a94516b3c1c6eba1015",
        url: "https://stats.dgraph.io",
        force_post: true,
      })
  	};
  	document.body.appendChild(cly);
  })();
</script>


<script>
$(document.links)
  .filter(function() {
    return this.hostname != window.location.hostname;
  })
  .attr("target", "_blank");
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/visibility.js/1.2.4/visibility.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
<link
  href='https://blog.dgraph.io//css/heart.css?24a50879951b2391f04750723b4a012e'
  rel="stylesheet">
<link
  href='https://blog.dgraph.io//css/github-engage.css?d60d80bf2b6a24350cdb5d834ab47e27'
  rel="stylesheet">

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"
  integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps="
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src='https://blog.dgraph.io//js/custom.js?94f0c667422b8dac293e14c9c49872e3'
></script>

<script src="//unpkg.com/@dgraph-io/community"></script>

   </div>
</body>
    <script src="https://blog.dgraph.io/js/footnotes.js"></script>

</html>
