<!DOCTYPE html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
  <link rel="canonical" href="https://blog.dgraph.io/post/encryption-at-rest-dgraph-badger/" />


  <link rel="apple-touch-icon" sizes="57x57" href="https://dgraph.io/assets/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://dgraph.io/assets/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://dgraph.io/assets/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://dgraph.io/assets/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://dgraph.io/assets/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://dgraph.io/assets/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://dgraph.io/assets/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://dgraph.io/assets/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://dgraph.io/assets/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"
    href="https://dgraph.io/assets/images/favicons/android-icon-192x192.png">
  <link rel="manifest" href="https://dgraph.io/assets/images/favicons/manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="https://dgraph.io/assets/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://dgraph.io/assets/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://dgraph.io/assets/images/faviconsfavicon-16x16.png">
  <link rel="shortcut icon" href="https://dgraph.io/assets/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="https://dgraph.io/assets/images/faviconsms-icon-144x144.png">
  <meta name="msapplication-config" content="https://dgraph.io/assets/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.dgraph.io//index.xml">
  
  <title>Encryption at Rest in Dgraph and Badger - Dgraph Blog</title>
  <meta property='og:title' content="Encryption at Rest in Dgraph and Badger - Dgraph Blog">
  <meta property="og:type" content="article">
  

  <meta property="og:url" content="https://blog.dgraph.io/post/encryption-at-rest-dgraph-badger/">
  
  
  <meta property="og:image" content="https://blog.dgraph.io//images/milky_way.jpg">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"
    integrity="sha256-0rguYS0qgS6L4qVzANq4kjxPLtvnp5nn2nB5G1lWRv4=" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/default.min.css" rel="stylesheet"
    integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js"
    integrity="sha256-sNPiigbfSkqUzMc5rgrdztLnneCMAp6W9wetJUZu9Zw=" crossorigin="anonymous"></script>
  <link
    href='https://blog.dgraph.io//css/runnable.css?7bbf71b4888bc97241e85bc7326a12fe'
    rel="stylesheet" />
  
  <link
    href='https://blog.dgraph.io//css/runnable-custom.css?74110b504a7b8a6e92a95279cfa96032'
    rel="stylesheet" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Mono:wght@400;500&display=swap" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />

  <link href="https://dgraph.io/assets/css/style.min.css?06042020-12" rel="stylesheet" type="text/css" />

  <link href="https://dgraph.io/assets/css/font-awesome/css/all.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital@1&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">


  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.js"
    integrity="sha256-x3BtPVERvw1ozPlwivuFLZoViFCeAAs1Gt6SxEedmo8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/codemirror.css"
    integrity="sha256-7sZe9dsqyNZC9Mk+WPRB7nVvPPPXyorzm2QKqlgXC4k=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/addon/edit/closebrackets.min.js"
    integrity="sha256-qhu2a7DSpQaammMaLw1iruxBpxmgdw8mdQaQWQUokcY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.25.0/mode/javascript/javascript.min.js"
    integrity="sha256-7Bdg/UdDMmHDPafpQDYZNPCEbnRP7eAvu+2hEoqRCXs=" crossorigin="anonymous"></script>
  

  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@3/dist/algoliasearch.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.0.0/dist/instantsearch.production.min.js"
    integrity="sha256-6S7q0JJs/Kx4kb/fv0oMjS855QTz5Rc2hh9AkIUjUsk=" crossorigin="anonymous"></script>
  <script src="https://blog.dgraph.io//js/search.js?04292020"></script>
  <script>

    $(".subscribe-box").hide();
    $(window).scroll(function () {
      if ($(window).scrollTop() > 220) {
        $(".subscribe-box").fadeIn("slow");
      }
      else {
        $(".subscribe-box").fadeOut("fast");
      }
    });
   
    
    
    $(window).scroll(function () {
      if ($(window).scrollTop() > 180) {
        $("#page-header").addClass("bg-white");
      }
      else {
        $("#page-header").removeClass("bg-white");
      }
    });

    $(document).scroll(function () {
      checkOffset();
    });

   
    function checkOffset() {
      var x = $(".container").offset();
        var leftPosition = x.left + 90;
      if ($('.subscribe-box').offset().top + $('.subscribe-box').height()
        >= $('.bottom-section').offset().top - 10){
        $('.subscribe-box').addClass('footer-before');
        $('.footer-before').css('left',  -leftPosition  );
        }
      if ($(document).scrollTop() + window.innerHeight < $('.bottom-section').offset().top){
        $('.subscribe-box').removeClass('footer-before');
        $('.subscribe-box').css('left',  '15px' );
      }
         
    }
    $(document).ready(function () {
      $( ".page-search" ).wrapInner( "<div class='wrapper'></div>")
      $('.wrapper').after($('.page-search__results'))

      $(".subscribe-box-mobi .click-btn").click(function () {
        $(".subscribe-box").toggleClass("open");
        $(".subscribe-box-mobi").toggleClass('hide');
      });
      $(".subscribe-box .close").click(function () {
        $(".subscribe-box").toggleClass("open");
        $(".subscribe-box-mobi").toggleClass('hide');
      });
      $('.nav-icon').click(function() {
	    $('.page-nav').toggleClass('shownav');
	    $(this).toggleClass('active');
  });
  var $nav = document.querySelector('.page-nav > ul');
	var $navItems = document.querySelectorAll('.page-nav > ul > li');
	var $navItemHeading = document.querySelectorAll('.page-nav > ul > li > div');
  var $subnav = document.querySelectorAll('.page-nav > ul > li > ul');
  $($navItemHeading).click(function(e) {
	    $($navItems).removeClass('active');
	    $(this).parent().toggleClass('active');
	});
  $('.nav-icon[target="_blank"]').removeAttr('target');
  var x = $(".container").offset();
  var leftPosition = x.left;
    });
  </script>

  
  
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://blog.dgraph.io//images/milky_way.jpg" />
  
  

  <meta name="twitter:title" content="Encryption at Rest in Dgraph and Badger" />
  <meta name="twitter:description"
    content="We built &ldquo;Encryption at Rest&rdquo; in Badger v2. Encryption is complex, but important. With this blog post, we not only want to introduce this feature to our users, but also dive into the details of how we implemented encryption in Badger, so the reader can gain enough understanding about introducing AES encryption in their own systems." />
  
  <meta name="twitter:site" content="@dgraphlabs" />

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-666192333"></script>
  <script>window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'AW-666192333');</script>
</head>

<body class="blog-single has-lightning" data-gr-c-s-loaded="true">

    <header id="page-header" class="page-header">
	<div class="page-logo">
		<a href="https://dgraph.io/">
			<img src="https://dgraph.io/assets/images/logo.svg">
		</a>
	</div>
	<nav class="page-nav">
    <ul>
        <li>
            <div data-label="Products">
                <span>Products</span>
            </div>
            <ul>
                <li>
                    <a href="https://dgraph.io/graphql" data-label="GraphQL">
                        <span>GraphQL</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/enterprise" data-label="Enterprise">
                        <span>Enterprise</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/downloads" data-label="Downloads">
                        <span>Downloads</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Learn" class="is-active">
                <span>Learn</span>
            </div>
            <ul>
                <li>
                    <a href="https://dgraph.io/blog" data-label="Blog">
                        <span>Blog</span>
                    </a>
                </li>
                <li>
                    <a href="https://tour.dgraph.io" target="_blank" data-label="Interactive Tour">
                        <span>Interactive Tour</span>
                    </a>
                </li>
                <li>
                    <a href="https://discuss.dgraph.io" target="_blank" data-label="Forum">
                        <span>Forum</span>
                    </a>
                </li>
                <li>
                    <a href="https://slack.dgraph.io" target="_blank" data-label="Slack">
                        <span>Slack</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Docs"><span>Docs</span></div>
            <ul>
                <li>
                    <a href="https://docs.dgraph.io" target="_blank" data-label="Dgraph Docs">
                        <span>Dgraph Docs</span>
                    </a>
                </li>
                <li>
                    <a href="https://graphql.dgraph.io/docs/" target="_blank" data-label="GraphQL Docs">
                        <span>GraphQL Docs</span>
                    </a>
                </li>
            </ul>
        </li>
        <li>
            <div data-label="Company"><span>Company</span></div>
            <ul>
                <li>
                    <a href="https://dgraph.io/about" data-label="Team">
                        <span>Team</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/careers" data-label="Careers">
                        <span>Careers</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/contact" data-label="Contact">
                        <span>Contact</span>
                    </a>
                </li>
                <li>
                    <a href="https://dgraph.io/conduct" data-label="Conduct">
                        <span>Conduct</span>
                    </a>
                </li>
            </ul>
        </li>
    </ul>
</nav>

	<div class="page-cta">
    <ul>
        <li class="hide-tablet">
            <a href="https://dgraph.io/contact" title="Contact">Contact</a>
        </li>
        <li>
            <a href="https://dgraph.io/downloads" title="Download" class="button button--secondary">
                <span>Download</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </li>
    </ul>
</div>

</header>




    <section class="page-body">
        <div class="page-body__content">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-10 ">

                        <div class="page-search form-group has-search">
	<span class="fas fa-search form-control-feedback"></span>
	
</div>
                     </div>
                </div>
            </div>
        </div>
        
        <div class="container">
            <div class="row justify-content-center">

                <div class="col-10 ">
                    <div class="">

                        <div class="post__meta">

                            <div class="post__date">

    
        Thu, Mar 12, 2020
    
    
</div>


                            <div class="post__share">
                                
                                <a href="https://twitter.com/share?text=Encryption%20at%20Rest%20in%20Dgraph%20and%20Badger&amp;url=https%3a%2f%2fblog.dgraph.io%2fpost%2fencryption-at-rest-dgraph-badger%2f&amp;via=dgraphlabs"
                                    target="_blank">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                
                            </div>

                        </div>

                        <div class="post__cover">

                            <img
                                src="https://blog.dgraph.io//images/milky_way.jpg">

                            <div class="post__header">

                                <h1 class="post__title">
                                    Encryption at Rest in Dgraph and Badger
                                </h1>

                                
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/balaji/">Balaji Jinnah</a>
        
    

</div>



                            </div>

                        </div>

                        <div class="post__content inner-content lg-pl-80 lg-pr-80 md-pl-50 md-pr-50 xs-pl-30 xs-pr-30 clearfix">
                            <p>We built &ldquo;Encryption at Rest&rdquo; in Badger <a href="https://blog.dgraph.io/post/releasing-badger-v2/">v2</a>. Encryption is complex, but
important.  With this blog post, we not only want to introduce this feature to
our users, but also dive into the details of how we implemented encryption in
Badger, so the reader can <strong>gain enough understanding about introducing AES
encryption</strong> in their own systems.</p>
<h3 id="background">Background</h3>
<p>In 2008, Microsoft released Transparent Data Encryption (<a href="https://en.wikipedia.org/wiki/Transparent_data_encryption">TDE</a>) to provide
Encryption at Rest to SQL server. Since then, TDE has become an expectation, if
not a requirement for databases. <a href="https://docs.oracle.com/database/121/ASOAG/introduction-to-transparent-data-encryption.htm#ASOAG10117">Oracle</a> supports it, <a href="https://docs.mongodb.com/manual/core/security-encryption-at-rest/">MongoDB</a> supports
it, <a href="https://wiki.postgresql.org/wiki/Transparent_Data_Encryption">PostgreSQL</a> is considering adding it in v14. TDE is important because it
is a stepping stone towards achieving security compliances like HIPAA and PCI
DSS, which require the protection of data at rest. With data protection
standards such as GDPR and the sheer mass of data that companies collect and
accumulate, the protection and control of information has become increasingly
important.</p>
<p><strong>Dgraph is dealing with similar expectations.</strong> But, instead of directly
building encryption into <a href="https://github.com/dgraph-io/dgraph">Dgraph</a>, we decided to offload that complexity onto
<a href="https://github.com/dgraph-io/badger">Badger</a>. This benefits not only Dgraph users, but the wider community using
Badger actively.</p>
<p>Badger is implemented as an embeddable library, which makes it especially
powerful for building more specialized or complex systems on top of it.
Layering systems on top of Badger provides a number of significant benefits.
Most importantly, it provides <a href="https://en.wikipedia.org/wiki/Separation_of_concerns">separation</a> of concerns. For example:</p>
<ul>
<li>Badger provides fast access to data by key on a single server, and it
manages the actual data on disk so it is in charge of data security.</li>
<li>Dgraph builds a graph database on top of Badger, and is also in charge of
scaling to multiple distributed servers.</li>
</ul>
<p>This means that we were able to add encryption to Badger with minimal changes to
<a href="https://github.com/dgraph-io/dgraph">Dgraph</a>, while adding encryption to Dgraph as well. <strong>The same benefit can
accrue to other layered systems that use Badger.</strong> Furthermore, because Badger
is a smaller, independent system, new features like encryption can be built,
tested, and verified more easily and with more confidence.</p>
<p>This is similar to the Internet Protocol
<a href="https://en.wikipedia.org/wiki/Internet_protocol_suite">Suite</a>, which provides
high level protocols like TCP on top of lower level protocols like IP. This
allows other high level protocols (e.g. UDP, DCCP, SCCP, RSVP) to be built on
top of IP. When improvements are made to IP (such as IPv4 to
<a href="https://en.wikipedia.org/wiki/IPv6">IPv6</a>), higher level protocols can all take
advantage of them easily.</p>
<h3 id="what-is-badger">What is Badger?</h3>
<p><a href="https://github.com/dgraph-io/badger">BadgerDB</a> is a key-value database (KVDB) designed for performance and
resilience. In benchmarks running on today’s typical cloud server hardware,
Badger provides <a href="https://blog.dgraph.io/post/badger-over-rocksdb-in-dgraph/">great</a> <a href="https://blog.dgraph.io/post/badger-lmdb-boltdb/">performance</a> compared to other popular KVDBs.
Badger can run concurrent <a href="https://blog.dgraph.io/post/badger-txn/">ACID</a> transactions using multiversion
concurrency control (<a href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>) providing serializable snapshot
isolation (<a href="https://wiki.postgresql.org/wiki/SSI">SSI</a>) guarantees. Badger provides resilience in the event of
process, filesystem or even hardware crashes.</p>
<p>In addition to speed and resilience, Badger&rsquo;s rich feature set and ease of use has
made it a popular library. It has quickly become <em>the most active</em> KVDB
written in Go.  On GitHub, <strong>Badger has over 7.3K stars and is used in over
850 <a href="https://github.com/dgraph-io/badger#other-projects-using-badger">projects</a>,</strong> including Uber&rsquo;s <a href="https://github.com/jaegertracing/jaeger">Jaeger</a> and <a href="https://github.com/ipfs/go-ipfs">IPFS</a>.
Most notable is <a href="https://www.usenetexpress.com/">UsenetExpress</a>, which uses
Badger to store <strong>petabytes of data</strong>.</p>
<h3 id="advanced-encryption-standard">Advanced Encryption Standard</h3>
<p><strong>Badger uses the highly regarded <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a> encryption algorithm,</strong> standardized
by the <a href="https://en.wikipedia.org/wiki/National_Institute_of_Standards_and_Technology">US NIST</a> and used by MongoDB, SQLite, and many other databases and
systems. Even RocksDB, the KVDB used by <a href="https://github.com/dgraph-io/dgraph">Dgraph</a> before Badger was created,
has since been <a href="https://github.com/facebook/rocksdb/pull/2424">enhanced</a> to support AES. In fact, AES has become an
industry standard as it is the most secure and widely used algorithm for
encrypting data. Wide use is critical for encryption standards for ensuring that
potential security flaws are found and fixed.</p>
<p>AES is symmetric; the same encryption key<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> is used for both encrypting and
decrypting data. Badger supports <a href="https://www.cryptomathic.com/news-events/blog/symmetric-cryptography-and-key-management-considerations-on-key-exhaustion-rotation-and-security-models">key rotation</a> to further secure access to
data. This allows Badger to be used in systems that need to meet the various
data protection regulations and requirements.</p>
<h3 id="the-need-for-key-rotation">The Need for Key Rotation</h3>
<p>To encrypt and decrypt data requires access to an encryption key. AES keys come
in three sizes: 128, 192, and 256 bits. Which size you use is actually <a href="https://proprivacy.com/guides/aes-encryption">not very
important</a>, as a brute force crack
of a 128-bit key would take the fastest computer in the world over a
hundred-quadrillion (10 to the 17th power) years. Even if you could get 10
million supercomputers to work together to do the crack, it would still take
longer than the current age of the universe.</p>
<p><strong>Much more important is maintaining the security of the key to avoid key
<a href="https://en.wikipedia.org/wiki/Information_leakage">leak</a></strong>. Obviously, encryption keys must be stored securely by the user and
should not be easy to guess. However, there are other sources of key leak. For
example, “side channel” attacks have been
<a href="https://resources.fox-it.com/rs/170-CAK-271/images/Tempest_attacks_against_AES.pdf">demonstrated</a>
that it is possible to crack even the most secure (256-bit) AES keys by
measuring electromagnetic radiation coming from a computer, using a device that
costs around $200 and can fit into a jacket pocket. Computers doing encryption
must be physically secure to prevent this.</p>
<p>Even without physical access, if the same key is used too often there are known
ways that attackers can determine the value of the key by analyzing large
amounts of data encrypted using that key. In order to avoid this, <strong>the key must
be changed
<a href="https://www.cryptomathic.com/news-events/blog/symmetric-cryptography-and-key-management-considerations-on-key-exhaustion-rotation-and-security-models">regularly</a>, which is referred to as
key rotation.</strong> However, when the key is changed, existing
encrypted data must be decrypted using the old key and then re-encrypted using
the new key. These computations would significantly reduce the performance for
encrypted data.</p>
<h3 id="one-key-to-rule-them-all-many-keys-to-find-them">One Key to Rule Them All, Many Keys to Find Them</h3>
<p>Instead of using the AES encryption key directly to encrypt data, Badger
uses two types of keys:</p>
<ul>
<li>A user provided AES encryption key, called the <strong>master key</strong>, is used to encrypt auto-generated data keys.</li>
<li><strong>Data keys</strong> are used to encrypt and decrypt data on disk. Each encrypted data key is stored on disk along with the encrypted data.</li>
</ul>
<p>The length of your master key must be 16, 24 or 32 characters. This determines
what version of AES encryption is used (AES-128, AES-192, and AES-256
respectively).</p>
<p>Note that <strong>you should never use a predictable string as your master key.</strong> If
you have a password manager (such as 1Password, LastPass, etc.), you can use its
built-in password generator to generate a strong encryption key. Even if you
don’t have a password manager, you can use a reputable online password
generator, such as <a href="https://1password.com/password-generator/">1Password</a> to generate your master key.</p>
<p><strong>You should rotate your master key on a regular schedule.</strong> Fortunately, because the
master key is used to encrypt only data keys, which are (even
all together) much smaller compared to the data stored in the database, the
master key does not need to be rotated as often (as data keys) to prevent key leak.
Even better, when the master key is rotated, only the data keys need to be
decrypted using the old master key, and then re-encrypted using the new master
key. This is tremendously faster than re-encrypting all of the data on disk.</p>
<h3 id="avoiding-encrypted-duplicates">Avoiding Encrypted Duplicates</h3>
<p>When data keys are used to encrypt data stored in the database, the same data
will often be encrypted multiple times before the rotation period for the data
key expires. Encrypting the same data with the same data key always generates
the same encrypted text to be stored in the database. This increases the ability
of an attacker to predict the original plaintext data.</p>
<p>To reduce the predictability of the original data, Badger incorporates a
standard encryption technique that doesn’t use the data key directly to encrypt
the data. Instead, <strong>Badger generates a random 16-byte array called an
<a href="https://en.wikipedia.org/wiki/Initialization_vector">Initialization Vector</a></strong>
(IV). The data key is used to encrypt the IV and then the encrypted IV is
XORed with the original data, and the result is stored on disk. This means that
<strong>even if the same block is encrypted multiple times,</strong> the random value of the
IV ensures that <strong>the stored text will be different each time.</strong></p>
<h3 id="storing-ivs-with-minimal-overhead">Storing IVs with Minimal Overhead</h3>
<p>Badger is based on <a href="https://blog.dgraph.io/post/badger/">LSM trees</a>. An advanced
feature of Badger’s implementation of LSM trees is that for <strong>values larger than a
certain user specified threshold size, it can separate the key-value pairs and
store the values in a value log</strong> (vlog). The LSM tree stores only the keys and
a pointer to the values. This separation results in much smaller LSM trees and
reduces both read and write amplification factors typically involved with them.
Assuming 16 bytes per key and 16 bytes per value pointer, a single
64MB file can store two million key-value pairs. For various datasets, the
entire LSM tree can fit in memory making the task of searching for a key much
faster.</p>
<p>The LSM tree is composed of many equally sized files called SSTables, arranged
into a pyramid-like structure. Each lower level in the pyramid is 10-15x the
size of its upper level. Each SSTable is further divided up into block
structures, where each block holds 4KB of data. <strong>Badger uses a unique IV to
encrypt each of these blocks and stores the IV in plaintext at the end of the
encrypted block.</strong> The storage overhead of a 16B IV over a 4KB is 0.4%.</p>
<p>Note that it is OK to store the IVs in plaintext. Assume that a cracker gets
access to the IV and encrypted block. To decrypt the block, they&rsquo;d need to
encrypt the IV with the data key (to XOR the encrypted data back to plaintext).
But to get access to the data key, they&rsquo;d need to decrypt it using the master
key. If master key is safe and secure, that won&rsquo;t be accessible, rendering the
effort futile. Thus, <strong>knowing the IV is not sufficient to decrypt the
data.</strong></p>
<p>Next, we need to encrypt the values stored in the vlog files. Each value is read
individually from a vlog file, using the value pointer from the LSM tree, which
stores the vlog file id, the offset in the file and the length of the value.
Aggregating multiple values into a block would cause a performance slowdown
because then more data would need to be decrypted to read one value. Therefore,
we decided to <strong>encrypt each value individually,</strong> keeping it in sync with the
access pattern of the value logs. But IVs are supposed to be random per
encrypted data block, in this case per value, so using one IV for the whole
value log file isn&rsquo;t ideal.</p>
<p><strong>How does Badger avoid the bloat of attaching a 16-byte IV to every value?</strong> To
optimize the encryption of the vlog entries, Badger uses a unique technique.
Instead of generating a 16-byte IV and storing it at the end of each value in
the vlog, Badger generates a 12-byte IV that is used for all values in a single
vlog file. Along with it, Badger attaches a 4-byte unique value that is the
offset of the value in the vlog file, which together make up the required
16-byte IV. For decryption, the 4-byte vlog offsets are available from the value
pointer stored with each key.</p>
<p>This technique saves 16 bytes of space on disk for every value in a vlog file.
For example, for a vlog file that contains 10,000 entries, storing an IV with
each value would require 160,000 bytes, while this technique only requires 12
bytes. Furthermore, for a typical 1GB of value log, this technique only adds a
12B overhead, even lower than an SSTable.</p>
<h3 id="key-rotation-revisited">Key Rotation Revisited</h3>
<p>By default, Badger rotates the data keys every ten days, automatically
generating new data keys whenever the old data keys expire. The user can change
this schedule using the <code>Options.WithEncryptionKeyRotationDuration</code>
<a href="https://godoc.org/github.com/dgraph-io/badger#Options.WithEncryptionKeyRotationDuration">function</a>. All data keys are stored together in a file and loaded into
memory when Badger is opened.</p>
<p><strong>All data keys ever used are always stored.</strong> Badger does not determine which
key is not being used and can be discarded. Here&rsquo;s why: Each data key is 32B, so
even a thousand of these keys only consume 32KB &mdash; a small size considering how
big Badger DBs can get (TBs/PBs). A thousand keys correspond to ten thousand
days ~ 27 years worth of data keys assuming a 10 day rotation cycle. So, we felt
it was OK for us to avoid the logical complexity of actively garbage collecting
data keys<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<p>While Badger rotates the data keys automatically, <strong>it is up to the user to rotate
the master key.</strong> The user is encouraged to rotate the master encryption key
frequently in order to ensure a higher level of security. This is done with the
<code>rotate</code> subcommand:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">badger rotate --dir<span style="color:#000;font-weight:bold">=</span>badger_dir --old-key-path<span style="color:#000;font-weight:bold">=</span>old/path --new-key-path<span style="color:#000;font-weight:bold">=</span>new/path
</code></pre></div><p>Note that currently, the Badger datastore must be offline in order to rotate the
master key. Because rotating the master key requires only that the data keys be
re-encrypted, this doesn’t take very long and should not be a significant
problem. In the future, the requirement that the datastore be offline might be
removed.</p>
<h3 id="enabling-encryption-on-an-existing-datastore">Enabling Encryption on an Existing Datastore</h3>
<p>You can enable encryption on a Badger DB instance using these <a href="https://godoc.org/github.com/dgraph-io/badger#Options.WithEncryptionKey">options</a>:</p>
<pre><code>opts := badger.DefaultOptions(&quot;/tmp/badger&quot;).
    WithEncryptionKey(masterKey).
    WithEncryptionKeyRotationDuration(dataKeyRotationDuration) # defaults to 10 days
</code></pre><p>If you have an existing Badger datastore that is not encrypted, enabling
encryption on it will not immediately encrypt your existing data all at once.
Instead, only <em>new files</em> are encrypted, which will happen as new data is
added. As older data gets compacted and newer files generated, those would also
get encrypted over time. Badger can run in this hybrid mode easily, as each
SSTable and value log file stores the information about the data key used for
encryption.</p>
<p><strong>In order to immediately encrypt all of an existing Badger datastore,</strong> you should:</p>
<ol>
<li>Export your Badger datastore</li>
<li>Start a new instance of Badger with encryption enabled</li>
<li>Import your data into the new Badger datastore.</li>
</ol>
<p>This can be done using <code>badger backup</code> and <code>badger restore</code> tools already
available. Otherwise, a simple tool could be written using <a href="https://godoc.org/github.com/dgraph-io/badger#DB.NewStream">Stream</a> Framework
and <a href="https://godoc.org/github.com/dgraph-io/badger#DB.NewStreamWriter">StreamWriter</a> interface to allow this to happen without exporting
and with a stunning <a href="https://blog.dgraph.io/post/badger-v1.6.0-release/">1.6Gbps</a> throughput.</p>
<h3 id="conclusion">Conclusion</h3>
<p><a href="https://github.com/dgraph-io/badger">Badger</a> supports Encryption at Rest (<a href="https://en.wikipedia.org/wiki/Transparent_data_encryption">TDE</a>) using established and proven
standards and best practices, implemented in a way that works well with the
existing features and benefits of Badger. And because <a href="https://github.com/dgraph-io/dgraph">Dgraph</a> is built on top
of Badger, you can also use strong encryption with Dgraph.</p>
<p>We are dedicated to adding important new features to Badger and Dgraph. Give
Encryption at Rest a try, and let us know how we can make it even better.</p>
<p><em>We&rsquo;d like to thank the Dgraph Developer Relations team who worked tirelessly in
helping write this blog post. It was an incredible team effort.</em></p>


<aside class="post__references">

    <h4>References</h4><p>Top image: <a href="https://assets.wired.com/photos/w_600/wp-content/uploads/2014/06/uhd_img_2528_cc.jpg">Glittering Milky Way Photo by ESO/B. Tafreshi</a></p>
</aside>

<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Note that when encryption is added to a key-value database the word “key”
becomes ambiguous, as it is used to refer to both the key of the key-value
pairs stored in Badger, and the key used to encrypt and decrypt those
key-value pairs.  When the context is not clear, this post will use
“encryption key” for the latter meaning. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>It shouldn&rsquo;t be too hard to introduce the garbage collection for data keys, if
there are use cases where this back of the envelope calculation breaks. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


                        
    <aside class="post__authors">
                <div class="tile author-tile">

    <img src="https://blog.dgraph.io/images/people/balaji.jpg" class="author-tile__photo">

    <h4 class="author-tile__title">
        <a href="https://blog.dgraph.io/authors/balaji/">Balaji Jinnah</a>,
        Author
    </h4>

    <p>Balaji is a Distributed Systems Engineer at Dgraph Labs, previously he was an
intern at AVI Networks. His superpowers include being able to build system in
both Go and Rust, and ship features at the pace of a thunderbolt. At Dgraph, he
brings a unique value addition as he contributes to all of Dgraph&rsquo;s significant
projects, and this includes Badger, Dgraph, Ristretto and GraphQL. When not at
work, you can find him contributing to a variety of open-source projects or at
the gym.</p>


    
        <nav class="author-tile__social">

            
                <a href="https://www.linkedin.com/in/balaji-jinnah-1253a395/" target="_blank">
                    <i class="fab fa-linkedin"></i>
                </a>
            

            
                <a href="https://twitter.com/hi_balaji" target="_blank">
                    <i class="fab fa-twitter"></i>
                </a>
            

            
                <a href="https://github.com/balajijinnah" target="_blank">
                    <i class="fab fa-github"></i>
                </a>
            

        </nav>
    

</div>

            
        
                <div class="tile author-tile">

    <img src="https://blog.dgraph.io/images/people/manish.jpg" class="author-tile__photo">

    <h4 class="author-tile__title">
        <a href="https://blog.dgraph.io/authors/mrjn/">Manish Rai Jain</a>,
        Editor
    </h4>

    <p>Manish is the Chief decision maker at Dgraph. He got thrust into distributed
systems right out of college, working on real time web indexing systems at
Google. He then lead various projects to consolidate and serve Knowledge Graph
right behind web search.</p>
<p>Implementing GTD and Zero Waste practices, Manish is into efficient and
minimalist living. He loves cycling, swimming and ultra light travelling.</p>


    
        <nav class="author-tile__social">

            

            
                <a href="https://twitter.com/manishrjain" target="_blank">
                    <i class="fab fa-twitter"></i>
                </a>
            

            
                <a href="https://github.com/manishrjain" target="_blank">
                    <i class="fab fa-github"></i>
                </a>
            

        </nav>
    

</div>

            
        

    </aside>



                        <div class="post__comments">

    <div id="discourse-comments"></div>

    
    <script type="text/javascript">
        DiscourseEmbed = {
            discourseUrl: "https:\/\/discuss.dgraph.io\/",
            topicId:  6118 
            };
        (function() {
            var d = document.createElement("script");
            d.type = "text/javascript";
            d.async = true;
            d.src = DiscourseEmbed.discourseUrl + "javascripts/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(d);
        })();
    </script>
    <noscript>Please enable JavaScript to view the comments on <a href="https://discuss.dgraph.io/">discuss</a>.</noscript>
    

</div>


                        <div class="modal fade" id="runnable-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <a href="#" data-dismiss="modal" class="modal-close-btn">
    Close
  </a>

  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">

      </div>
    </div>
  </div>
</div>
                    </div>

                    
                    <div class=" bg-gray xs-pt-60 xs-pb-60 round text-center md-pl-80 md-pr-80 own-success-story xs-mb-80 md-ml-80 md-mr-80">
                        <p>Create you own success story.</p>
                        <h2 class="font-medium">Interpret, store, distribute and execute GraphQL with the best.</h2>
                        <div class="xs-mt-50 d-flex align-items-center justify-content-center flex-column flex-md-row">
                            <a href="https://dgraph.io/downloads" class="button button--primary mr-0 mr-md-3"><span>Get Started</span> <i class="fas fa-arrow-right"></i></a>
                            <a class="button  button--outline" target="_blank" href="https://github.com/dgraph-io/dgraph"><span>View<span> on Github</span></span><i class="fas fa-arrow-right"></i></a>
                        </div>

                    </div>
                    <div class="  text-center subscribe-box">
    

    <h3>Get blog post to <br/>your inbox</h3>
    

<div id="mc_embed_signup">
<form action="https://dgraph.us17.list-manage.com/subscribe/post?u=f6c6a28bb40d10e26b88fff1c&amp;id=e85c448cac" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	
<div class="mc-field-group">
	
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="your Email">
</div>
	<div id="mce-responses" class="clear">
		<div class="response" id="mce-error-response" style="display:none"></div>
		<div class="response" id="mce-success-response" style="display:none"></div>
	</div>    
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_f6c6a28bb40d10e26b88fff1c_e85c448cac" tabindex="-1" value=""></div>
    <div class="clear"><button type="submit"  name="subscribe" id="mc-embedded-subscribe" class="button button--secondary mt-2"><span>Subscribe</span><i class="fas fa-arrow-right"></i></button></div>
    </div>
</form>
</div>
<script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<div class="d-flex align-items-center justify-content-center mt-4">
    <a href="https://github.com/dgraph-io/dgraph" target="_blank" ><i class="fa fa-github px-3"></i></a>
    <a href="https://slack.dgraph.io/" target="_blank"  ><i class="fa fa-slack px-3"></i></a>
    <a href="https://discuss.dgraph.io/" target="_blank"  ><i class="fa fa-comments px-3"></i></a>
</div>
<div class="close position-absolute d-block d-lg-none"><i class="fa fa-close"></i></div>

</div>

<div class="subscribe-box-mobi">
    <div class="d-flex align-items-center justify-content-center  flex-column">
        <a href="https://github.com/dgraph-io/dgraph" target="_blank" ><i class="fa fa-github py-3"></i></a>
        <a href="https://slack.dgraph.io/" target="_blank"  ><i class="fa fa-slack py-3"></i></a>
        <a href="https://discuss.dgraph.io/" target="_blank"  ><i class="fa fa-comments py-3"></i></a>
        <div class="click-btn"><i class="fa fa-envelope-o py-3"></i></div>

    </div>

</div>




            </div>


                    
                </div>
            </div>
           


        </div>
        </div>
    </section>
    <div class='bottom-section'>
        <div class="container">
            <div class="page-body__related-content mb-4">

                




<h3 class=" font-22 pb-4">But wait, there’s more...</h3>

<div class=" row justify-content-center mt-4">


    
    <div class="post col-sm-4">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/badger2.jpg">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Mon, Nov 18, 2019
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/releasing-badger-v2/">Releasing BadgerDB v2.0</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/karthic/">Karthic Rao</a>
        
    

</div>



    	</div>

    </div>
    
    <div class="post col-sm-4">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/landing-soyuz.png">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Wed, Jul 3, 2019
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/badger-v1.6.0-release/">Releasing BadgerDB v1.6.0</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/francesc/">Francesc Campoy</a>
        
    

</div>



    	</div>

    </div>
    
    <div class="post col-sm-4">

        <div class="post__image">
    <img src="https://blog.dgraph.io//images/badger-evolution.png">
</div>


    	<div class="post__header">

    		<div class="post__date">

    
        Thu, Jun 27, 2019
    
    
</div>


    		<h4 class="post__title">
    			<a href="https://blog.dgraph.io/post/serialization-versioning/">Semantic Versioning, Go Modules, and Databases</a>
    		</h4>

    		
<div class="post__byline">

    
            by <a href="https://blog.dgraph.io/authors/francesc/">Francesc Campoy</a>
        
    

</div>



    	</div>

    </div>
    

</div>




                
<div class="post__tags">

    <h3>Tags</h3>

    <div>

        
            
            
                <a href="https://blog.dgraph.io/tags/badger/">badger</a>
            
        
            
            
                <a href="https://blog.dgraph.io/tags/encryption/">encryption</a>
            
        

    </div>

</div>




            </div>
        </div>
        <footer class="page-footer">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-5 col-sm-4">
        <div class="row">
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Products</h3>
            <ul>
              <li><a href="https://dgraph.io/graphql">GraphQL</a></li>
              <li><a href="https://dgraph.io/enterprise">Enterprise</a></li>
              <li><a href="https://dgraph.io/downloads">Downloads</a></li>
            </ul>
          </div>
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Learn</h3>
            <ul>
              <li><a href="https://dgraph.io/blog" target="_blank">Blog</a></li>
              <li><a href="https://tour.dgraph.io" target="_blank">Interactive Tour</a></li>
              <li><a href="https://discuss.dgraph.io" target="_blank">Forum</a></li>
              <li><a href="https://slack.dgraph.io" target="_blank">Slack</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-5 col-sm-4">
        <div class="row">
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Docs</h3>
            <ul>
              <li><a href="https://docs.dgraph.io" target="_blank">Dgraph Docs</a></li>
              <li><a href="https://graphql.dgraph.io/docs/" target="_blank">GraphQL Docs</a></li>
            </ul>
          </div>
          <div class="col-12 col-md-6 page-footer__nav">
            <h3 class="zeta">Company</h3>
            <ul>
              <li><a href="https://dgraph.io/about">Team</a></li>
              <li><a href="https://dgraph.io/careers">Careers</a></li>
              <li><a href="https://dgraph.io/contact">Contact</a></li>
              <li><a href="https://dgraph.io/conduct">Conduct</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3 offset-lg-1 border-above-sm">
        <div class="page-footer__cta"><a href="https://dgraph.io/downloads" title="Download" class="button button--secondary"><span>Download</span><i class="fas fa-arrow-right"></i></a></div>
        <div class="page-footer__address">
          <p>
            655 Montgomery Street, 7th Floor<br>
            San Francisco, CA 94111
          </p>
          <hr>
          <p><a href="mailto:contact@dgraph.io">contact@dgraph.io</a></p>
        </div>
      </div>
    </div>
    <div class="page-footer__social">
      <ul>
        <li><a href="https://twitter.com/dgraphlabs" target="_blank"><i class="fab fa-twitter"></i></a></li>
        <li><a href="https://github.com/dgraph-io/dgraph" target="_blank"><i class="fab fa-github"></i></a></li>
        <li><a href="https://www.youtube.com/channel/UCghE41LR8nkKFlR3IFTRO4w" target="_blank"><i class="fab fa-youtube"></i></a></li>
        <li><a href="https://slack.dgraph.io" target="_blank"><i class="fab fa-slack"></i></a></li>
        <li><a href="https://www.linkedin.com/company/dgraph-labs" target="_blank"><i class="fab fa-linkedin"></i></a></li>
      </ul>
    </div>
    <div class="page-footer__copyright">
      <p>
        <Copyright>&copy; 2017-2020 Dgraph Labs, Inc.</Copyright>
      </p>
    </div>
  </div>
</footer>

    <script src="https://blog.dgraph.io//js/clipboard.min.js"></script>
    <script
      src='https://blog.dgraph.io//js/runnable.js?29f8ba4fb8d90804cf24ff53b70192ad'
    ></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>




<script>
  window.Countly = window.Countly || {};
  Countly.q = Countly.q || [];

  Countly.q.push(['track_sessions']);
  Countly.q.push(['track_pageview']);
  (function() {
  	var cly = document.createElement('script');
  	cly.type = 'text/javascript';
  	cly.async = true;
  	cly.src = "https://dgraph.io/assets/js/unminified/stats/dgraph-stats.min.js";
  	cly.onload = function() {
      Countly.init({
        app_key: "e93284ab5e5d21ef9eb16a94516b3c1c6eba1015",
        url: "https://stats.dgraph.io",
        force_post: true,
      })
  	};
  	document.body.appendChild(cly);
  })();
</script>


<script>
$(document.links)
  .filter(function() {
    return this.hostname != window.location.hostname;
  })
  .attr("target", "_blank");
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/visibility.js/1.2.4/visibility.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
<link
  href='https://blog.dgraph.io//css/heart.css?24a50879951b2391f04750723b4a012e'
  rel="stylesheet">
<link
  href='https://blog.dgraph.io//css/github-engage.css?d60d80bf2b6a24350cdb5d834ab47e27'
  rel="stylesheet">

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"
  integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps="
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src='https://blog.dgraph.io//js/custom.js?94f0c667422b8dac293e14c9c49872e3'
></script>

<script src="//unpkg.com/@dgraph-io/community"></script>



    </div>



</body>

    <script src="https://blog.dgraph.io/js/footnotes.js"></script>

</html>
